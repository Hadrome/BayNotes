<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BayNotes å…±äº«ç¬”è®°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .prose h1 { font-size: 1.8em; font-weight: 800; margin-bottom: 0.5em; }
        .prose p { margin-bottom: 1em; line-height: 1.7; color: #334155; }
        .prose ul, .prose ol { padding-left: 1.5em; margin-bottom: 1em; }
        .prose ul { list-style: disc; }
        .prose pre { background: #1e293b; color: white; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
        .prose blockquote { border-left: 4px solid #cbd5e1; padding-left: 1em; color: #64748b; font-style: italic; }
        .prose img { border-radius: 0.5em; max-width: 100%; }
        .prose a { color: #2563eb; text-decoration: underline; }
    </style>
</head>
<body class="bg-[#F5F5F7] min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-3xl bg-white rounded-3xl shadow-xl overflow-hidden min-h-[50vh] flex flex-col relative">
        
        <div v-if="loading" class="absolute inset-0 flex items-center justify-center bg-white z-10">
            <div class="animate-pulse text-slate-400">æ­£åœ¨åŠ è½½ç¬”è®°...</div>
        </div>

        <div v-if="needPwd" class="absolute inset-0 z-20 bg-white/90 backdrop-blur flex flex-col items-center justify-center p-8 text-center">
            <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100 max-w-sm w-full">
                <div class="text-4xl mb-4">ğŸ”’</div>
                <h3 class="text-lg font-bold mb-2">æ­¤ç¬”è®°å—å¯†ç ä¿æŠ¤</h3>
                <p class="text-sm text-slate-400 mb-4">è¯·è¾“å…¥è®¿é—®å¯†ç ä»¥æŸ¥çœ‹å†…å®¹</p>
                <input v-model="pwdInput" type="text" placeholder="è®¿é—®å¯†ç " class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 outline-none focus:border-blue-500 mb-3 text-center">
                <button @click="fetchNote" class="w-full bg-slate-900 text-white py-2 rounded-lg font-medium">è§£é”</button>
                <p v-if="error" class="text-red-500 text-xs mt-2">{{ error }}</p>
            </div>
        </div>

        <div v-if="!loading && !needPwd && error" class="flex-1 flex flex-col items-center justify-center text-center p-8">
            <div class="text-4xl mb-4">ğŸ˜•</div>
            <h1 class="text-xl font-bold text-slate-800">æ— æ³•è®¿é—®</h1>
            <p class="text-slate-500 mt-2">{{ error }}</p>
        </div>

        <div v-if="note" class="p-8 sm:p-12">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">{{ note.title }}</h1>
            <div class="text-sm text-slate-400 mb-8 pb-4 border-b border-gray-100 flex justify-between">
                <span>{{ formatDate(note.created_at) }}</span>
                <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-xs font-bold">BayNotes Shared</span>
            </div>
            
            <div v-if="note.is_encrypted" class="bg-gray-50 border border-dashed border-gray-200 rounded-xl p-8 text-center">
                <p class="text-slate-500">ğŸ”’ æ­¤å†…å®¹æ˜¯åŠ å¯†ç¬”è®°ï¼Œæ— æ³•åœ¨å…¬å¼€é“¾æ¥ä¸­è§£å¯†ã€‚</p>
            </div>
            
            <div v-else class="prose prose-slate max-w-none" v-html="renderedContent"></div>
        </div>

    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, onMounted, computed } = Vue;
        createApp({
            setup() {
                const loading = ref(true);
                const needPwd = ref(false);
                const error = ref('');
                const note = ref(null);
                const pwdInput = ref('');
                
                const params = new URLSearchParams(window.location.search);
                const shareId = params.get('id');

                const renderedContent = computed(() => note.value ? marked.parse(note.value.content) : '');

                const fetchNote = async () => {
                    loading.value = true;
                    error.value = '';
                    try {
                        let url = `/api/share?id=${shareId}`;
                        if (pwdInput.value) url += `&pwd=${pwdInput.value}`;
                        
                        const res = await fetch(url);
                        const data = await res.json();
                        
                        if (res.status === 403 && data.needPwd) {
                            needPwd.value = true;
                            loading.value = false;
                            return;
                        }

                        if (!res.ok) throw new Error(data.error || 'è®¿é—®å¤±è´¥');
                        
                        needPwd.value = false;
                        note.value = data;
                    } catch (e) {
                        error.value = e.message;
                    } finally {
                        loading.value = false;
                    }
                };

                const formatDate = (ts) => new Date(ts * 1000).toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });

                onMounted(() => {
                    if(!shareId) { error.value = "é“¾æ¥æ— æ•ˆ"; loading.value = false; return; }
                    fetchNote();
                });

                return { loading, needPwd, error, note, pwdInput, fetchNote, renderedContent, formatDate };
            }
        }).mount('#app');
    </script>
</body>
</html>
