<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BayNotes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* Notion-like Sidebar Styles */
        .sidebar-item { 
            @apply flex items-center gap-2 px-3 py-1.5 rounded-md cursor-pointer text-slate-500 hover:bg-gray-200/60 hover:text-slate-900 transition-colors duration-200 text-sm font-medium select-none; 
        }
        .sidebar-item.active { 
            @apply bg-gray-200/80 text-slate-900; 
        }
        .sidebar-section-title {
            @apply text-xs font-semibold text-slate-400 px-3 mt-6 mb-1 select-none;
        }

        /* Note List Styles */
        .note-item { 
            @apply p-3 rounded-lg cursor-pointer border border-transparent hover:bg-gray-100 transition duration-150 mb-1; 
        }
        .note-item.active { 
            @apply bg-white border-gray-200 shadow-sm; 
        }

        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 2px; }
        .custom-scroll:hover::-webkit-scrollbar-thumb { background: #cbd5e1; }

        /* Editor Typography */
        .editor-title { @apply text-4xl font-bold text-slate-800 outline-none mb-6 placeholder-gray-200 bg-transparent w-full; }
        .editor-content { @apply flex-1 w-full outline-none resize-none text-slate-600 leading-relaxed bg-transparent font-mono text-sm; }
        
        /* Toolbar */
        .toolbar-btn { @apply p-1.5 rounded hover:bg-gray-100 text-slate-400 hover:text-slate-700 transition; }
    </style>
</head>
<body class="bg-white text-slate-800 h-screen flex overflow-hidden selection:bg-blue-100">
    
    <div id="app" class="w-full flex relative">

        <div v-if="!user" class="absolute inset-0 z-[100] flex items-center justify-center bg-gray-50/90 backdrop-blur-sm">
            <div class="w-full max-w-sm bg-white rounded-2xl shadow-2xl border border-gray-100 p-8 transform transition-all">
                <div class="text-center mb-8">
                    <div class="text-5xl mb-3">ğŸŒŠ</div>
                    <h1 class="text-2xl font-bold text-slate-800">BayNotes</h1>
                    <p class="text-slate-400 text-sm mt-1">æç®€ã€å®‰å…¨ã€æµç•…çš„äº‘ç¬”è®°</p>
                </div>
                <div class="space-y-4">
                    <input v-model="authForm.username" placeholder="ç”¨æˆ·å" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm outline-none focus:border-slate-400 focus:ring-0 transition">
                    <input v-model="authForm.password" type="password" placeholder="å¯†ç " class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm outline-none focus:border-slate-400 focus:ring-0 transition">
                    <input v-if="mode==='register'" v-model="authForm.inviteCode" placeholder="é‚€è¯·ç " class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm outline-none focus:border-slate-400">
                    <button @click="handleAuth" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-3 rounded-xl text-sm font-bold transition shadow-lg shadow-slate-200 transform active:scale-95">{{ mode==='login'?'è¿›å…¥å·¥ä½œåŒº':'ç«‹å³æ³¨å†Œ' }}</button>
                    <div class="text-center text-xs text-slate-400 cursor-pointer mt-2 hover:text-slate-600 underline decoration-dotted" @click="mode = mode==='login'?'register':'login'">
                        {{ mode==='login'?'æ²¡æœ‰è´¦å·ï¼Ÿåˆ›å»ºæ–°è´¦å·':'å·²æœ‰è´¦å·ï¼Ÿè¿”å›ç™»å½•' }}
                    </div>
                </div>
            </div>
        </div>

        <template v-else>
            <aside :class="sidebarOpen ? 'w-60 opacity-100' : 'w-0 opacity-0 overflow-hidden'" class="flex-shrink-0 bg-[#F7F7F5] border-r border-gray-200 flex flex-col transition-all duration-300 ease-in-out">
                
                <div class="p-3">
                    <div class="flex items-center gap-3 px-2 py-2 cursor-pointer hover:bg-gray-200/50 rounded-lg transition mb-2">
                        <div class="w-6 h-6 rounded bg-orange-400 text-white flex items-center justify-center text-xs font-bold shadow-sm">{{ user.username[0].toUpperCase() }}</div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-semibold truncate text-slate-700">{{ user.username }}'s Space</div>
                        </div>
                    </div>

                    <div @click="doSearch" :class="{active: currentView==='search'}" class="sidebar-item mb-4">
                        <i class="ph ph-magnifying-glass text-lg"></i> æœç´¢
                    </div>

                    <div class="space-y-0.5">
                        <div @click="setView('all')" :class="{active: currentView==='all'}" class="sidebar-item">
                            <i class="ph ph-house text-lg"></i> å…¨éƒ¨ç¬”è®°
                        </div>
                        <div @click="setView('shared')" :class="{active: currentView==='shared'}" class="sidebar-item">
                            <i class="ph ph-globe text-lg"></i> æˆ‘çš„åˆ†äº«
                        </div>
                        <div @click="setView('trash')" :class="{active: currentView==='trash'}" class="sidebar-item group justify-between">
                            <span class="flex items-center gap-2"><i class="ph ph-trash text-lg"></i> å›æ”¶ç«™</span>
                            <span v-if="trashCount > 0" class="text-xs bg-gray-200 px-1.5 rounded-full text-slate-500">{{trashCount}}</span>
                        </div>
                    </div>

                    <div class="sidebar-section-title flex justify-between group">
                        <span>æ–‡ä»¶å¤¹</span>
                        <i @click.stop="createFolder(null)" class="ph ph-plus hover:text-slate-800 cursor-pointer opacity-0 group-hover:opacity-100 transition"></i>
                    </div>
                    
                    <div class="space-y-0.5 overflow-y-auto custom-scroll" style="max-height: 40vh;">
                        <div v-for="folder in rootFolders" :key="folder.id">
                            <div @click="setView('folder', folder.id)" :class="{active: currentView === 'folder' && currentFolderId === folder.id}" class="sidebar-item justify-between group">
                                <span class="flex items-center gap-2 truncate"><i class="ph ph-folder-notch text-slate-400"></i> {{ folder.name }}</span>
                                <div class="hidden group-hover:flex gap-1 text-slate-400">
                                    <i @click.stop="createFolder(folder.id)" class="ph ph-plus hover:text-slate-800 p-0.5" title="æ–°å»ºå­æ–‡ä»¶å¤¹"></i>
                                    <i @click.stop="deleteFolder(folder.id)" class="ph ph-trash hover:text-red-500 p-0.5"></i>
                                </div>
                            </div>
                            <div v-for="sub in getSubFolders(folder.id)" :key="sub.id" 
                                 @click="setView('folder', sub.id)"
                                 :class="{active: currentView === 'folder' && currentFolderId === sub.id}"
                                 class="sidebar-item pl-8 text-xs group justify-between">
                                <span class="truncate flex items-center gap-2 before:content-[''] before:w-1 before:h-1 before:bg-slate-300 before:rounded-full">{{ sub.name }}</span>
                                <i @click.stop="deleteFolder(sub.id)" class="ph ph-trash hidden group-hover:block hover:text-red-500 text-slate-400"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-auto p-3 border-t border-gray-200">
                     <div v-if="user.role === 'admin'" @click="showAdminPanel=true" class="sidebar-item">
                        <i class="ph ph-gear"></i> ç®¡ç†é¢æ¿
                    </div>
                    <div @click="logout" class="sidebar-item text-slate-500 hover:bg-red-50 hover:text-red-600">
                        <i class="ph ph-sign-out"></i> é€€å‡ºç™»å½•
                    </div>
                </div>
            </aside>

            <div class="w-64 flex-shrink-0 border-r border-gray-200 flex flex-col bg-[#FCFBF9]"> <div class="h-12 flex items-center px-4 border-b border-gray-100 justify-between shrink-0 bg-white/50 backdrop-blur">
                    <span class="font-semibold text-sm text-slate-600 flex items-center gap-2">
                        <button v-if="!sidebarOpen" @click="sidebarOpen=true"><i class="ph ph-list"></i></button>
                        {{ getViewTitle() }}
                    </span>
                    <button @click="initNewNote" class="text-slate-400 hover:text-slate-800 transition transform hover:scale-110" title="æ–°å»ºç¬”è®°">
                        <i class="ph ph-plus-circle text-xl"></i>
                    </button>
                </div>
                
                <div class="flex-1 overflow-y-auto custom-scroll p-2">
                    <div v-if="currentView === 'search'" class="mb-3 px-1 transition-all">
                        <div class="relative">
                            <i class="ph ph-magnifying-glass absolute left-2 top-2 text-slate-400"></i>
                            <input ref="searchInputRef" v-model="searchQuery" @keyup.enter="fetchNotes" placeholder="è¾“å…¥å…³é”®å­—å›è½¦..." 
                                   class="w-full text-sm bg-white border border-gray-200 rounded-lg py-1.5 pl-8 pr-2 outline-none focus:border-blue-500 shadow-sm">
                        </div>
                    </div>

                    <div v-for="note in notes" :key="note.id" @click="selectNote(note)" 
                         :class="currentNote.id === note.id ? 'active' : ''"
                         class="note-item group relative">
                        <div class="flex items-center gap-1.5 mb-1.5">
                            <i v-if="note.is_encrypted" class="ph ph-lock-key-fill text-yellow-500 text-xs"></i>
                            <h4 class="font-medium text-sm truncate text-slate-700">{{ note.title || 'æ— æ ‡é¢˜' }}</h4>
                        </div>
                        <p class="text-xs text-slate-400 line-clamp-2 h-8 leading-relaxed">
                            {{ note.is_encrypted ? 'ğŸ™ˆ å†…å®¹å·²éšè—' : (note.content || 'æ— å†…å®¹...') }}
                        </p>
                        <div class="absolute right-2 top-2 hidden group-hover:flex bg-white shadow-sm border border-gray-100 rounded opacity-90">
                            <button v-if="currentView==='trash'" @click.stop="restoreNote(note)" class="p-1 text-green-500 hover:bg-green-50" title="æ¢å¤"><i class="ph ph-arrow-u-up-left"></i></button>
                            <button @click.stop="deleteNote(note)" class="p-1 text-slate-400 hover:text-red-500 hover:bg-red-50" title="åˆ é™¤"><i class="ph ph-trash"></i></button>
                        </div>
                    </div>
                    
                    <div v-if="notes.length === 0" class="flex flex-col items-center justify-center text-slate-300 mt-20 gap-2">
                        <i class="ph ph-tray text-3xl"></i>
                        <span class="text-xs">æ²¡æœ‰ç¬”è®°</span>
                    </div>
                </div>
            </div>

            <main class="flex-1 flex flex-col bg-white min-w-0 relative">
                <header class="h-12 border-b border-gray-100 flex items-center justify-between px-6 shrink-0 bg-white z-10">
                    <div class="flex items-center gap-2 text-xs text-slate-400">
                        <button @click="sidebarOpen = !sidebarOpen" class="hover:text-slate-800 mr-2 transition"><i class="ph ph-arrows-left-right text-lg"></i></button>
                        <span>{{ currentNote.folderId ? getFolderName(currentNote.folderId) : 'æ ¹ç›®å½•' }}</span>
                        <span v-if="currentNote.created_at">/ {{ formatDate(currentNote.created_at) }}</span>
                    </div>
                    
                    <div v-if="hasActiveNote && currentView !== 'trash'" class="flex items-center gap-3">
                         <span class="text-[10px] uppercase tracking-wider text-slate-300 font-bold transition-opacity duration-500" :class="saveStatus === 'å·²åŒæ­¥' ? 'opacity-50' : 'opacity-100 text-blue-500'">{{ saveStatus }}</span>
                         
                         <div class="h-4 w-px bg-gray-200"></div>

                         <button @click="toggleEncryption" :class="currentNote.is_encrypted ? 'text-yellow-500 bg-yellow-50' : 'text-slate-400 hover:text-slate-600'" class="p-1.5 rounded-md transition" title="åŠ å¯†/è§£å¯†">
                             <i :class="currentNote.is_encrypted ? 'ph-lock-key-fill' : 'ph-lock-key-open'" class="ph text-lg"></i>
                         </button>
                         
                         <button @click="openShare(currentNote)" :class="currentNote.share_id ? 'text-blue-500 bg-blue-50' : 'text-slate-400 hover:text-slate-600'" class="flex items-center gap-1 px-2 py-1.5 rounded-md transition text-xs font-medium">
                            <i class="ph ph-share-network text-lg"></i> {{ currentNote.share_id ? 'å·²åˆ†äº«' : 'åˆ†äº«' }}
                        </button>
                    </div>
                </header>

                <div v-if="hasActiveNote && currentView !== 'trash'" class="flex-1 flex flex-col overflow-hidden relative">
                    
                    <div v-if="currentNote.is_encrypted && !isDecryptedSession" class="flex-1 flex flex-col items-center justify-center text-slate-400 bg-gray-50/30">
                        <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100 text-center">
                            <i class="ph ph-lock-key text-5xl mb-4 text-yellow-500 block"></i>
                            <h3 class="text-slate-800 font-bold mb-1">å†…å®¹å·²åŠ å¯†</h3>
                            <p class="text-xs text-slate-400 mb-6">è¯·è¾“å…¥å¯†ç è§£é”æŸ¥çœ‹æˆ–ç¼–è¾‘</p>
                            <button @click="promptDecrypt" class="px-6 py-2 bg-slate-900 text-white text-sm rounded-lg hover:bg-slate-800 transition font-medium w-full shadow-lg shadow-slate-200">è¾“å…¥å¯†ç </button>
                        </div>
                    </div>

                    <div v-else class="flex-1 flex flex-col h-full relative">
                        <div class="h-10 border-b border-gray-100 flex items-center px-8 gap-1 shrink-0 bg-white/80 backdrop-blur">
                            <button @click="insertFormat('**', '**')" class="toolbar-btn" title="åŠ ç²—"><i class="ph ph-text-b"></i></button>
                            <button @click="insertFormat('*', '*')" class="toolbar-btn" title="æ–œä½“"><i class="ph ph-text-italic"></i></button>
                            <button @click="insertFormat('`', '`')" class="toolbar-btn" title="ä»£ç "><i class="ph ph-code"></i></button>
                            <div class="h-4 w-px bg-gray-200 mx-1"></div>
                            <button @click="insertFormat('# ', '')" class="toolbar-btn" title="å¤§æ ‡é¢˜"><i class="ph ph-text-h-one"></i></button>
                            <button @click="insertFormat('## ', '')" class="toolbar-btn" title="å°æ ‡é¢˜"><i class="ph ph-text-h-two"></i></button>
                            <button @click="insertFormat('- ', '')" class="toolbar-btn" title="åˆ—è¡¨"><i class="ph ph-list-dashes"></i></button>
                            <button @click="insertFormat('> ', '')" class="toolbar-btn" title="å¼•ç”¨"><i class="ph ph-quotes"></i></button>
                            <div class="h-4 w-px bg-gray-200 mx-1"></div>
                            <button @click="insertFormat('[', '](url)')" class="toolbar-btn" title="é“¾æ¥"><i class="ph ph-link"></i></button>
                            <button @click="showPreview = !showPreview" :class="showPreview ? 'text-blue-600 bg-blue-50' : ''" class="toolbar-btn ml-auto" title="é¢„è§ˆå¼€å…³"><i class="ph ph-eye"></i></button>
                        </div>

                        <div class="flex-1 flex flex-row overflow-hidden">
                            <div class="flex-1 flex flex-col max-w-3xl mx-auto w-full px-8 py-8 h-full overflow-y-auto custom-scroll">
                                <input v-model="currentNote.title" @input="debouncedSave" placeholder="æ— æ ‡é¢˜" class="editor-title">
                                <textarea id="mainEditor" v-model="currentNote.content" @input="debouncedSave" placeholder="å¼€å§‹è®°å½•..." class="editor-content custom-scroll"></textarea>
                            </div>
                            
                            <div v-if="showPreview" class="hidden lg:block w-1/2 border-l border-gray-100 bg-gray-50 p-8 overflow-y-auto custom-scroll">
                                <div class="prose prose-sm prose-slate max-w-none" v-html="previewHtml"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="flex-1 flex flex-col items-center justify-center text-slate-300 select-none">
                    <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                        <i class="ph ph-pencil-slash text-4xl text-slate-200"></i>
                    </div>
                    <p class="text-sm font-medium text-slate-400">é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªç¬”è®°</p>
                </div>
            </main>
        </template>

        <div v-if="pwdModal.show" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/20 backdrop-blur-sm transition-opacity">
            <div class="bg-white p-6 rounded-xl w-80 shadow-2xl transform scale-100 transition-transform">
                <div class="text-center mb-4">
                    <div class="bg-gray-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2 text-xl">ğŸ”</div>
                    <h3 class="font-bold text-slate-800">{{ pwdModal.mode === 'encrypt' ? 'è®¾ç½®åŠ å¯†å¯†ç ' : 'è§£é”ç¬”è®°' }}</h3>
                </div>
                <input type="password" v-model="pwdModal.input" @keyup.enter="handlePwdSubmit" autofocus placeholder="åœ¨æ­¤è¾“å…¥å¯†ç ..." class="w-full border border-gray-200 bg-gray-50 rounded-lg px-3 py-2 text-sm mb-4 outline-none focus:border-blue-500 focus:bg-white transition">
                <div class="flex gap-2">
                    <button @click="pwdModal.show=false" class="flex-1 py-2 text-sm text-slate-500 hover:bg-gray-50 rounded-lg font-medium">å–æ¶ˆ</button>
                    <button @click="handlePwdSubmit" class="flex-1 py-2 text-sm bg-slate-900 text-white rounded-lg hover:bg-slate-800 font-medium">ç¡®å®š</button>
                </div>
            </div>
        </div>

        <div v-if="shareModal.show" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/20 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-xl w-80 shadow-xl">
                <h3 class="font-bold mb-4 flex items-center gap-2"><i class="ph ph-share-network text-blue-500"></i> åˆ†äº«ç¬”è®°</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center">
                        <label class="text-slate-600">æœ‰æ•ˆæœŸ (å¤©)</label>
                        <input v-model="shareModal.days" type="number" class="border p-1 w-16 text-center rounded bg-gray-50 focus:bg-white outline-none focus:border-blue-500">
                    </div>
                    <input v-model="shareModal.pwd" placeholder="è®¿é—®å¯†ç  (å¯é€‰)" class="w-full border border-gray-200 p-2 rounded bg-gray-50 focus:bg-white outline-none focus:border-blue-500">
                    <label class="flex items-center gap-2 text-slate-600 cursor-pointer select-none">
                        <input type="checkbox" v-model="shareModal.burn" class="accent-red-500"> 
                        <span :class="shareModal.burn ? 'text-red-500 font-medium' : ''">é˜…åå³ç„š</span>
                    </label>
                    <button @click="doShare" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition">ç”Ÿæˆ/æ›´æ–°é“¾æ¥</button>
                    <div v-if="shareModal.result" class="bg-green-50 p-3 rounded-lg border border-green-100 mt-2">
                        <p class="text-[10px] text-green-600 mb-1 font-bold uppercase">Public Link</p>
                        <p class="text-xs break-all select-all font-mono text-slate-700">{{ shareModal.result }}</p>
                    </div>
                </div>
                <button @click="shareModal.show=false" class="absolute top-4 right-4 text-slate-300 hover:text-slate-500"><i class="ph ph-x text-lg"></i></button>
            </div>
        </div>

        <div v-if="showAdminPanel" class="fixed inset-0 z-[60] bg-black/20 backdrop-blur-sm flex items-center justify-center p-4">
             <div class="bg-white w-full max-w-3xl h-[80vh] rounded-2xl shadow-xl flex flex-col overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50"><h2 class="font-bold text-slate-700">Admin Console</h2><button @click="showAdminPanel=false"><i class="ph ph-x text-lg hover:text-red-500"></i></button></div>
                <div class="flex-1 overflow-auto p-4"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-400 uppercase bg-gray-50"><tr><th class="p-3">User</th><th class="p-3">Role</th><th class="p-3">Perms</th><th class="p-3 text-right">Action</th></tr></thead><tbody><tr v-for="u in adminUsers" :key="u.id" class="border-b hover:bg-gray-50"><td class="p-3 font-medium">{{u.username}}</td><td class="p-3"><span class="bg-gray-100 px-2 py-0.5 rounded text-xs">{{u.role}}</span></td><td class="p-3 text-xs text-slate-400">{{u.permissions}}</td><td class="p-3 text-right"><button @click="resetPwd(u)" class="text-blue-500 mr-3 hover:underline">Reset Pwd</button><button v-if="u.role!=='admin'" @click="delUser(u)" class="text-red-500 hover:underline">Del</button></td></tr></tbody></table></div>
             </div>
        </div>

    </div>

<script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
        createApp({
            setup() {
                const sidebarOpen = ref(true);
                const currentView = ref('all');
                const currentFolderId = ref(null);
                const searchQuery = ref('');
                const showPreview = ref(false); 
                const searchInputRef = ref(null);
                
                const user = ref(null);
                const notes = ref([]);
                const folders = ref([]);
                const currentNote = ref(null);
                
                // è§£å¯†ä¼šè¯çŠ¶æ€
                const isDecryptedSession = ref(false); 
                const saveStatus = ref('å·²åŒæ­¥');
                
                const mode = ref('login');
                const authForm = ref({ username: '', password: '', inviteCode: '' });
                const pwdModal = ref({ show: false, mode: 'encrypt', input: '' });
                const currentNotePwd = ref('');
                const showAdminPanel = ref(false);
                const adminUsers = ref([]);
                const shareModal = ref({ show: false, noteId: null, days: 7, pwd: '', burn: false, result: '' });

                const rootFolders = computed(() => folders.value.filter(f => !f.parent_id));
                const getSubFolders = (pid) => folders.value.filter(f => f.parent_id === pid);
                const previewHtml = computed(() => currentNote.value ? marked.parse(currentNote.value.content || '') : '');
                
                const hasActiveNote = computed(() => currentNote.value && (currentNote.value.id || currentNote.value.isNew));
                const trashCount = computed(() => 0); 

                onMounted(() => {
                    const saved = localStorage.getItem('baynotes_user');
                    if(saved) { 
                        try {
                            user.value = JSON.parse(saved); 
                            loadData(); 
                        } catch(e) { logout(); }
                    }
                });

                watch(showAdminPanel, (val) => { if(val) fetchAdminUsers(); });

                // â˜… ä¿®å¤ï¼šæ›´ç¨³å¥çš„ API è¯·æ±‚å°è£…
                const api = async (url, opts={}) => {
                    const token = localStorage.getItem('baynotes_token');
                    if(!token) {
                        console.warn("No token found, logging out...");
                        return logout();
                    }
                    opts.headers = { ...opts.headers, 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
                    
                    try {
                        const res = await fetch(url, opts);
                        
                        // å¦‚æœæ˜¯ 401 æœªæˆæƒï¼Œæç¤ºåé€€å‡º
                        if(res.status === 401) {
                            console.error("API returned 401 Unauthorized");
                            logout();
                            return res; // è¿”å› res é˜²æ­¢åç»­ crashï¼Œä½† logout ä¼šé‡è½½
                        }
                        return res;
                    } catch (e) {
                        console.error("Network Error:", e);
                        alert("ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°");
                        throw e;
                    }
                };

                const loadData = async () => {
                    // â˜… ä¿®å¤ï¼šåˆ†æ­¥åŠ è½½ï¼Œå³ä½¿æ–‡ä»¶å¤¹å¤±è´¥ä¹Ÿä¸å½±å“ä¸»ç•Œé¢
                    try {
                        const folderRes = await api('/api/folders');
                        if(folderRes.ok) {
                            folders.value = await folderRes.json();
                        } else {
                            console.warn("Failed to load folders:", await folderRes.text());
                        }
                    } catch(e) { console.error("Load folders error", e); }

                    await fetchNotes();
                };

                const fetchNotes = async () => {
                    if(currentView.value === 'search' && !searchQuery.value.trim()) {
                        notes.value = []; return;
                    }
                    try {
                        let url = `/api/notes?type=${currentView.value}`;
                        if(currentView.value === 'folder') url += `&folderId=${currentFolderId.value}`;
                        if(currentView.value === 'search') url += `&q=${encodeURIComponent(searchQuery.value)}`;
                        
                        const res = await api(url);
                        if(res.ok) notes.value = await res.json();
                    } catch(e) { console.error("Fetch notes error", e); }
                };

                const setView = (v, id=null) => { 
                    currentView.value=v; 
                    currentFolderId.value=id; 
                    currentNote.value=null;
                    if(v!=='search') searchQuery.value=''; 
                    fetchNotes(); 
                };

                const doSearch = () => { 
                    searchQuery.value=''; 
                    currentView.value='search'; 
                    currentNote.value=null;
                    notes.value = []; 
                    nextTick(() => { if(searchInputRef.value) searchInputRef.value.focus(); });
                };

                // â˜… ä¿®å¤ï¼šç™»å½•é€»è¾‘å¢å¼ºï¼Œé˜²æ­¢æ— ååº”
                const handleAuth = async () => {
                    if(!authForm.value.username || !authForm.value.password) return alert("è¯·è¾“å…¥è´¦å·å¯†ç ");
                    
                    try {
                        const res = await fetch('/api/auth', { 
                            method: 'POST', 
                            headers: {'Content-Type':'application/json'}, 
                            body: JSON.stringify({action:mode.value, ...authForm.value})
                        });
                        
                        // å…ˆå°è¯•è§£æ JSON
                        let data;
                        try {
                            data = await res.json();
                        } catch(jsonErr) {
                            throw new Error("æœåŠ¡å™¨è¿”å›äº†é JSON æ ¼å¼æ•°æ® (å¯èƒ½æ˜¯ 500 é”™è¯¯)");
                        }

                        if(!res.ok) throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
                        
                        if(mode.value==='register') { 
                            alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•"); 
                            mode.value='login'; 
                        } else { 
                            console.log("Login success:", data.user);
                            // 1. å…ˆå­˜ Token
                            localStorage.setItem('baynotes_token', data.token); 
                            localStorage.setItem('baynotes_user', JSON.stringify(data.user)); 
                            
                            // 2. ç«‹å³æ›´æ–° UIï¼Œè®©ç”¨æˆ·çœ‹åˆ°ç•Œé¢
                            user.value = data.user; 
                            
                            // 3. ç¨ååŠ è½½æ•°æ®ï¼Œé¿å…æ•°æ®åŠ è½½é”™è¯¯é˜»å¡ UI
                            setTimeout(() => loadData(), 100);
                        }
                    } catch(e) { 
                        alert("ç™»å½•é”™è¯¯: " + e.message);
                        console.error(e);
                    }
                };

                const logout = () => { 
                    // å¦‚æœæ­£åœ¨è°ƒè¯•ï¼Œå¯ä»¥å°† location.reload() æ³¨é‡Šæ‰ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æŠ¥é”™
                    localStorage.clear(); 
                    user.value=null; 
                    location.reload(); 
                };

                // ... å…¶ä»–è¾…åŠ©å‡½æ•°ä¿æŒä¸å˜ ...
                const getViewTitle = () => {
                    if(currentView.value === 'all') return 'å…¨éƒ¨ç¬”è®°';
                    if(currentView.value === 'trash') return 'å›æ”¶ç«™';
                    if(currentView.value === 'shared') return 'æˆ‘çš„åˆ†äº«';
                    if(currentView.value === 'search') return 'æœç´¢';
                    const f = folders.value.find(f=>f.id===currentFolderId.value);
                    return f ? f.name : 'æ–‡ä»¶å¤¹';
                };
                const getFolderName = (id) => { const f = folders.value.find(x=>x.id===id); return f?f.name:'...'; };
                const formatDate = (ts) => new Date(ts*1000).toLocaleString('zh-CN', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});

                const initNewNote = () => {
                    currentNote.value = { isNew: true, title: '', content: '', is_encrypted: 0, folderId: currentView.value==='folder' ? currentFolderId.value : null };
                    isDecryptedSession.value = true;
                    currentNotePwd.value = '';
                    if(window.innerWidth < 768) sidebarOpen.value = false;
                };

                const selectNote = (note) => {
                    currentNote.value = { ...note };
                    currentNotePwd.value = ''; 
                    isDecryptedSession.value = !note.is_encrypted;
                };

                const toggleEncryption = () => {
                    if(currentNote.value.is_encrypted) {
                        if(!isDecryptedSession.value) { alert("è¯·å…ˆè§£å¯†ï¼"); return; }
                        if(confirm("ç¡®å®šè¦ç§»é™¤åŠ å¯†ä¿æŠ¤å—ï¼Ÿ")) {
                            currentNote.value.is_encrypted = 0;
                            currentNotePwd.value = '';
                            saveNote();
                        }
                    } else {
                        pwdModal.value = { show: true, mode: 'encrypt', input: '' };
                    }
                };

                const promptDecrypt = () => { pwdModal.value = { show: true, mode: 'decrypt', input: '' }; };

                const handlePwdSubmit = () => {
                    const pwd = pwdModal.value.input;
                    if(!pwd) return;
                    if(pwdModal.value.mode === 'encrypt') {
                        currentNote.value.is_encrypted = 1;
                        currentNotePwd.value = pwd;
                        isDecryptedSession.value = true; 
                        saveNote(); 
                    } else {
                        try {
                            const bytes = CryptoJS.AES.decrypt(currentNote.value.content, pwd);
                            const original = bytes.toString(CryptoJS.enc.Utf8);
                            if(!original) throw new Error();
                            currentNote.value.content = original;
                            currentNotePwd.value = pwd;
                            isDecryptedSession.value = true; 
                        } catch(e) { alert("å¯†ç é”™è¯¯"); return; }
                    }
                    pwdModal.value.show = false;
                    pwdModal.value.input = '';
                };

                const insertFormat = (before, after) => {
                    const textarea = document.getElementById('mainEditor');
                    if(!textarea) return;
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const text = currentNote.value.content || '';
                    const newText = text.substring(0, start) + before + text.substring(start, end) + after + text.substring(end);
                    currentNote.value.content = newText;
                    nextTick(() => {
                        textarea.focus();
                        textarea.selectionStart = start + before.length;
                        textarea.selectionEnd = end + before.length;
                    });
                    debouncedSave();
                };

                let timeout;
                const debouncedSave = () => {
                    saveStatus.value = 'æ­£åœ¨åŒæ­¥...';
                    clearTimeout(timeout);
                    timeout = setTimeout(saveNote, 800);
                };

                const saveNote = async () => {
                    if(!currentNote.value) return;
                    if(!currentNote.value.title && !currentNote.value.content && currentNote.value.isNew) { saveStatus.value = 'æœªä¿å­˜'; return; }
                    let contentToSend = currentNote.value.content;
                    if(currentNote.value.is_encrypted) {
                        if(!currentNotePwd.value) { saveStatus.value = 'é”™è¯¯ï¼šå¯†é’¥ä¸¢å¤±'; return; }
                        contentToSend = CryptoJS.AES.encrypt(currentNote.value.content, currentNotePwd.value).toString();
                    }
                    const payload = { ...currentNote.value, content: contentToSend };
                    const res = await api('/api/notes', { method: 'POST', body: JSON.stringify(payload) });
                    if(res.ok) {
                        const data = await res.json();
                        if(currentNote.value.isNew) {
                            currentNote.value.id = data.id;
                            delete currentNote.value.isNew;
                            notes.value.unshift(currentNote.value);
                        }
                        const idx = notes.value.findIndex(n=>n.id===currentNote.value.id);
                        if(idx!==-1) {
                            notes.value[idx].title = currentNote.value.title;
                            notes.value[idx].content = contentToSend; 
                            notes.value[idx].is_encrypted = currentNote.value.is_encrypted;
                        }
                        saveStatus.value = 'å·²åŒæ­¥';
                    } else { saveStatus.value = 'åŒæ­¥å¤±è´¥'; }
                };
                
                const createFolder = async (pid) => { const n=prompt("è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°"); if(n) { await api('/api/folders', {method:'POST', body:JSON.stringify({name:n, parentId:pid})}); loadData(); }};
                const deleteFolder = async (id) => { if(confirm("ç¡®å®šåˆ é™¤æ–‡ä»¶å¤¹åŠå…¶æ‰€æœ‰å†…å®¹å—?")) { await api(`/api/folders?id=${id}`, {method:'DELETE'}); loadData(); }};
                const deleteNote = async (n) => { if(confirm("ç¡®è®¤åˆ é™¤?")) { await api(`/api/notes?id=${n.id}${currentView.value==='trash'?'&type=hard':''}`, {method:'DELETE'}); fetchNotes(); if(currentNote.value && currentNote.value.id===n.id) currentNote.value=null; }};
                const restoreNote = async (n) => { alert("è¯·å¤åˆ¶å†…å®¹é‡å»º"); };
                const openShare = (n) => { shareModal.value.noteId=n.id; shareModal.value.show=true; shareModal.value.result=''; };
                const doShare = async () => {
                    const res = await api('/api/notes', {method:'PATCH', body:JSON.stringify({ ...shareModal.value, noteId: currentNote.value.id })});
                    const d = await res.json();
                    shareModal.value.result = `${window.location.origin}/view.html?id=${d.shareId}`;
                    currentNote.value.share_id = d.shareId;
                };
                const fetchAdminUsers = async () => { const r=await api('/api/admin'); if(r.ok) adminUsers.value=await r.json(); };
                const resetPwd = async (u) => { const p=prompt("New Pwd"); if(p) api('/api/admin', {method:'POST', body:JSON.stringify({targetUserId:u.id, action:'reset_password', newPassword:p})}); };
                const delUser = async (u) => { if(confirm("Del?")) { await api(`/api/admin?id=${u.id}`, {method:'DELETE'}); fetchAdminUsers(); }};

                return {
                    sidebarOpen, currentView, currentFolderId, searchQuery, showPreview, searchInputRef,
                    user, notes, folders, rootFolders, getSubFolders, 
                    currentNote, hasActiveNote, isDecryptedSession, saveStatus, trashCount,
                    mode, authForm, pwdModal, showAdminPanel, adminUsers, shareModal, previewHtml,
                    setView, doSearch, getViewTitle, getFolderName, formatDate, selectNote, toggleEncryption, promptDecrypt, handlePwdSubmit, debouncedSave, initNewNote, insertFormat, createFolder, deleteFolder, deleteNote, restoreNote, openShare, doShare, handleAuth, logout, resetPwd, delUser, fetchAdminUsers
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

