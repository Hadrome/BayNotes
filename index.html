<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BayNotes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .sidebar-item { @apply flex items-center gap-2 px-3 py-1.5 rounded-md cursor-pointer text-slate-500 hover:bg-gray-100 hover:text-slate-900 transition text-sm font-medium; }
        .sidebar-item.active { @apply bg-gray-100 text-slate-900; }
        .note-item { @apply p-3 rounded-lg cursor-pointer border border-transparent hover:bg-gray-50 transition mb-1; }
        .note-item.active { @apply bg-white border-gray-200 shadow-sm; }
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 2px; }
        .prose { font-size: 0.95rem; line-height: 1.7; color: #374151; }
        .prose h1 { font-size: 1.75em; letter-spacing: -0.02em; margin-bottom: 0.5em; font-weight: 700; }
        .prose p { margin-bottom: 1em; }
    </style>
</head>
<body class="bg-white text-slate-800 h-screen flex overflow-hidden">
    
    <div id="app" class="w-full flex relative">

        <div v-if="!user" class="absolute inset-0 z-[100] flex items-center justify-center bg-gray-50">
            <div class="w-full max-w-sm bg-white rounded-xl shadow-xl border border-gray-100 p-8">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-2">ğŸŒŠ</div>
                    <h1 class="text-xl font-bold">BayNotes</h1>
                </div>
                <div class="space-y-3">
                    <input v-model="authForm.username" placeholder="ç”¨æˆ·å" class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm outline-none focus:border-blue-500 transition">
                    <input v-model="authForm.password" type="password" placeholder="å¯†ç " class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm outline-none focus:border-blue-500 transition">
                    <input v-if="mode==='register'" v-model="authForm.inviteCode" placeholder="é‚€è¯·ç " class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm outline-none">
                    <button @click="handleAuth" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-2.5 rounded-lg text-sm font-bold transition">{{ mode==='login'?'ç™»å½•':'æ³¨å†Œ' }}</button>
                    <div class="text-center text-xs text-slate-400 cursor-pointer mt-2 hover:text-slate-600" @click="mode = mode==='login'?'register':'login'">
                        {{ mode==='login'?'åˆ›å»ºæ–°è´¦å·':'è¿”å›ç™»å½•' }}
                    </div>
                </div>
            </div>
        </div>

        <template v-else>
            <aside :class="sidebarOpen ? 'w-60' : 'w-0 opacity-0 overflow-hidden'" class="flex-shrink-0 bg-gray-50/50 border-r border-gray-200 flex flex-col transition-all duration-300">
                
                <div class="p-4 flex items-center gap-3 cursor-pointer hover:bg-gray-100 transition m-2 rounded-lg">
                    <div class="w-8 h-8 rounded bg-slate-200 flex items-center justify-center text-xs font-bold">{{ user.username[0].toUpperCase() }}</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-semibold truncate">{{ user.username }}'s Space</div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto px-2 space-y-0.5">
                    <div @click="doSearch" class="sidebar-item mb-2 text-slate-400">
                        <i class="ph ph-magnifying-glass"></i> æœç´¢
                    </div>

                    <div class="text-xs font-semibold text-slate-400 px-3 mt-4 mb-1">PAGES</div>
                    <div @click="setView('all')" :class="{active: currentView==='all'}" class="sidebar-item">
                        <i class="ph ph-files"></i> å…¨éƒ¨ç¬”è®°
                    </div>
                    <div @click="setView('shared')" :class="{active: currentView==='shared'}" class="sidebar-item">
                        <i class="ph ph-share-network"></i> æˆ‘çš„åˆ†äº«
                    </div>
                    <div @click="setView('trash')" :class="{active: currentView==='trash'}" class="sidebar-item">
                        <i class="ph ph-trash"></i> å›æ”¶ç«™
                    </div>

                    <div class="text-xs font-semibold text-slate-400 px-3 mt-6 mb-1 flex justify-between group">
                        <span>FOLDERS</span>
                        <i @click.stop="createFolder(null)" class="ph ph-plus hover:text-slate-800 cursor-pointer opacity-0 group-hover:opacity-100 transition"></i>
                    </div>
                    
                    <div v-for="folder in rootFolders" :key="folder.id">
                        <div @click="setView('folder', folder.id)" :class="{active: currentView === 'folder' && currentFolderId === folder.id}" class="sidebar-item justify-between group">
                            <span class="flex items-center gap-2 truncate"><i class="ph ph-folder text-slate-400"></i> {{ folder.name }}</span>
                            <div class="hidden group-hover:flex gap-1 text-slate-400">
                                <i @click.stop="createFolder(folder.id)" class="ph ph-plus hover:text-slate-800" title="æ–°å»ºå­æ–‡ä»¶å¤¹"></i>
                                <i @click.stop="deleteFolder(folder.id)" class="ph ph-trash hover:text-red-500"></i>
                            </div>
                        </div>
                        <div v-for="sub in getSubFolders(folder.id)" :key="sub.id" 
                             @click="setView('folder', sub.id)"
                             :class="{active: currentView === 'folder' && currentFolderId === sub.id}"
                             class="sidebar-item pl-8 text-xs group justify-between">
                            <span class="truncate">{{ sub.name }}</span>
                            <i @click.stop="deleteFolder(sub.id)" class="ph ph-trash hidden group-hover:block hover:text-red-500 text-slate-400"></i>
                        </div>
                    </div>
                </div>

                <div class="p-2 border-t border-gray-200">
                     <div v-if="user.role === 'admin'" @click="showAdminPanel=true" class="sidebar-item">
                        <i class="ph ph-gear"></i> è®¾ç½®ä¸ç®¡ç†
                    </div>
                    <div @click="logout" class="sidebar-item text-red-500 hover:bg-red-50">
                        <i class="ph ph-sign-out"></i> ç™»å‡º
                    </div>
                </div>
            </aside>

            <div class="w-64 flex-shrink-0 border-r border-gray-200 flex flex-col bg-gray-50/30">
                <div class="h-12 flex items-center px-4 border-b border-gray-100 justify-between shrink-0">
                    <span class="font-semibold text-sm text-slate-500">{{ getViewTitle() }}</span>
                    <button @click="initNewNote" class="text-slate-400 hover:text-slate-800"><i class="ph ph-plus-circle text-lg"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto custom-scroll p-2">
                    <div v-if="currentView === 'search'" class="mb-2 px-1">
                        <input v-model="searchQuery" @keyup.enter="fetchNotes" placeholder="è¾“å…¥å…³é”®å­—å›è½¦..." class="w-full text-xs bg-white border border-gray-200 rounded p-1.5 outline-none">
                    </div>

                    <div v-for="note in notes" :key="note.id" @click="selectNote(note)" 
                         :class="currentNote.id === note.id ? 'active' : ''"
                         class="note-item group relative">
                        <div class="flex items-center gap-1.5 mb-1">
                            <i v-if="note.is_encrypted" class="ph ph-lock-key-fill text-yellow-500 text-xs"></i>
                            <h4 class="font-medium text-sm truncate text-slate-700">{{ note.title || 'æ— æ ‡é¢˜' }}</h4>
                        </div>
                        <p class="text-xs text-slate-400 line-clamp-2 h-8 leading-relaxed">
                            {{ note.is_encrypted ? 'å†…å®¹å·²åŠ å¯†' : (note.content || 'æ— å†…å®¹...') }}
                        </p>
                        <div class="absolute right-2 top-2 hidden group-hover:flex bg-white shadow-sm border border-gray-100 rounded">
                            <button v-if="currentView==='trash'" @click.stop="restoreNote(note)" class="p-1 text-green-500 hover:bg-green-50"><i class="ph ph-arrow-u-up-left"></i></button>
                            <button @click.stop="deleteNote(note)" class="p-1 text-red-400 hover:bg-red-50"><i class="ph ph-trash"></i></button>
                        </div>
                    </div>
                    
                    <div v-if="notes.length === 0" class="text-center text-xs text-slate-300 mt-10">
                        ç©ºç©ºå¦‚ä¹Ÿ
                    </div>
                </div>
            </div>

            <main class="flex-1 flex flex-col bg-white min-w-0 relative">
                <header class="h-12 border-b border-gray-100 flex items-center justify-between px-6 shrink-0">
                    <div class="flex items-center gap-2 text-xs text-slate-400">
                        <button @click="sidebarOpen = !sidebarOpen" class="hover:text-slate-800 mr-2"><i class="ph ph-list text-lg"></i></button>
                        <span>{{ currentNote.folderId ? getFolderName(currentNote.folderId) : 'æ ¹ç›®å½•' }}</span>
                        <span v-if="currentNote.id">/ æœ€åç¼–è¾‘äº {{ formatDate(currentNote.created_at) }}</span>
                    </div>
                    <div v-if="currentNote.id && currentView !== 'trash'" class="flex items-center gap-3">
                         <span class="text-xs text-slate-300">{{ saveStatus }}</span>
                         
                         <button @click="toggleEncryption" :class="currentNote.is_encrypted ? 'text-yellow-500 bg-yellow-50' : 'text-slate-400 hover:text-slate-600'" class="p-1.5 rounded-md transition" title="åŠ å¯†/è§£å¯†">
                             <i :class="currentNote.is_encrypted ? 'ph-lock-key-fill' : 'ph-lock-key-open'" class="ph text-lg"></i>
                         </button>
                         
                         <button @click="openShare(currentNote)" :class="currentNote.share_id ? 'text-blue-500 bg-blue-50' : 'text-slate-400 hover:text-slate-600'" class="flex items-center gap-1 px-2 py-1 rounded-md transition text-xs font-medium">
                            <i class="ph ph-share-network text-lg"></i> {{ currentNote.share_id ? 'å·²åˆ†äº«' : 'åˆ†äº«' }}
                        </button>
                    </div>
                </header>

                <div v-if="currentNote.id && currentView !== 'trash'" class="flex-1 flex flex-col overflow-hidden">
                    <div v-if="currentNote.is_encrypted && !decryptedContent" class="flex-1 flex flex-col items-center justify-center text-slate-400">
                        <i class="ph ph-lock-key text-4xl mb-3 text-slate-200"></i>
                        <p class="text-sm mb-4">æ­¤ç¬”è®°å·²åŠ å¯†</p>
                        <button @click="promptDecrypt" class="px-4 py-2 bg-slate-900 text-white text-sm rounded-lg hover:bg-slate-800 transition">è¾“å…¥å¯†ç æŸ¥çœ‹</button>
                    </div>

                    <div v-else class="flex-1 flex flex-col md:flex-row h-full">
                        <div class="flex-1 flex flex-col max-w-3xl mx-auto w-full px-8 py-8 h-full overflow-y-auto custom-scroll">
                            <input v-model="currentNote.title" @input="debouncedSave" placeholder="æ— æ ‡é¢˜" class="text-4xl font-bold text-slate-800 outline-none mb-6 placeholder-gray-200 bg-transparent">
                            <textarea v-model="currentNote.content" @input="debouncedSave" placeholder="è¾“å…¥å†…å®¹..." class="flex-1 w-full outline-none resize-none text-slate-600 leading-relaxed bg-transparent font-mono text-sm"></textarea>
                        </div>
                        <div v-if="showPreview" class="hidden lg:block w-1/2 border-l border-gray-100 bg-gray-50 p-8 overflow-y-auto prose custom-scroll" v-html="previewHtml"></div>
                    </div>
                </div>

                <div v-else class="flex-1 flex items-center justify-center text-slate-200">
                    <div class="text-center">
                        <i class="ph ph-pencil-simple-slash text-6xl mb-4"></i>
                        <p class="text-sm">é€‰æ‹©ç¬”è®°å¼€å§‹ç¼–è¾‘</p>
                    </div>
                </div>
            </main>
        </template>

        <div v-if="pwdModal.show" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/20 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-xl w-80 shadow-2xl">
                <h3 class="font-bold mb-2">{{ pwdModal.mode === 'encrypt' ? 'è®¾ç½®åŠ å¯†å¯†ç ' : 'è¾“å…¥ç¬”è®°å¯†ç ' }}</h3>
                <p class="text-xs text-slate-400 mb-4">{{ pwdModal.mode === 'encrypt' ? 'è¯·è®°ä½æ­¤å¯†ç ï¼Œä¸¢å¤±æ— æ³•æ‰¾å›ï¼' : 'è§£å¯†åå¯æŸ¥çœ‹å’Œç¼–è¾‘' }}</p>
                <input type="password" v-model="pwdModal.input" @keyup.enter="handlePwdSubmit" autofocus class="w-full border border-gray-200 rounded-lg p-2 text-sm mb-4 outline-none focus:border-blue-500">
                <div class="flex gap-2">
                    <button @click="pwdModal.show=false" class="flex-1 py-2 text-sm text-slate-500 hover:bg-gray-50 rounded-lg">å–æ¶ˆ</button>
                    <button @click="handlePwdSubmit" class="flex-1 py-2 text-sm bg-slate-900 text-white rounded-lg">ç¡®å®š</button>
                </div>
            </div>
        </div>

        <div v-if="showAdminPanel" class="fixed inset-0 z-[60] bg-black/20 backdrop-blur-sm flex items-center justify-center p-4">
             <div class="bg-white w-full max-w-3xl h-[80vh] rounded-2xl shadow-xl flex flex-col overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center"><h2 class="font-bold">Admin</h2><button @click="showAdminPanel=false"><i class="ph ph-x"></i></button></div>
                <div class="flex-1 overflow-auto p-4"><table class="w-full text-sm text-left"><thead class="bg-gray-50"><tr><th class="p-2">User</th><th class="p-2">Role</th><th class="p-2">Perms</th><th class="p-2 text-right">Action</th></tr></thead><tbody><tr v-for="u in adminUsers" :key="u.id" class="border-b"><td class="p-2">{{u.username}}</td><td class="p-2">{{u.role}}</td><td class="p-2 text-xs text-slate-400">{{u.permissions}}</td><td class="p-2 text-right"><button @click="resetPwd(u)" class="text-blue-500 mr-2">Pwd</button><button v-if="u.role!=='admin'" @click="delUser(u)" class="text-red-500">Del</button></td></tr></tbody></table></div>
             </div>
        </div>

        <div v-if="shareModal.show" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/20 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-xl w-80 shadow-xl">
                <h3 class="font-bold mb-4">åˆ†äº«ç¬”è®°</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center">
                        <label>æœ‰æ•ˆæœŸ (å¤©)</label>
                        <input v-model="shareModal.days" type="number" class="border p-1 w-16 text-center rounded">
                    </div>
                    <input v-model="shareModal.pwd" placeholder="è®¿é—®å¯†ç  (å¯é€‰)" class="w-full border p-2 rounded outline-none focus:border-blue-500">
                    <label class="flex items-center gap-2"><input type="checkbox" v-model="shareModal.burn"> é˜…åå³ç„š</label>
                    <button @click="doShare" class="w-full bg-blue-600 text-white py-2 rounded font-medium">ç”Ÿæˆ/æ›´æ–°é“¾æ¥</button>
                    <div v-if="shareModal.result" class="bg-gray-50 p-2 rounded border border-gray-200 mt-2">
                        <p class="text-[10px] text-green-600 mb-1">é“¾æ¥å·²ç”Ÿæˆ:</p>
                        <p class="text-xs break-all select-all font-mono text-slate-600">{{ shareModal.result }}</p>
                    </div>
                </div>
                <button @click="shareModal.show=false" class="mt-4 w-full text-slate-400 text-sm hover:text-slate-600">å…³é—­</button>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        createApp({
            setup() {
                const sidebarOpen = ref(true);
                const currentView = ref('all');
                const currentFolderId = ref(null);
                const searchQuery = ref('');
                const showPreview = ref(false); // æš‚æ—¶é»˜è®¤å…³é—­é¢„è§ˆï¼Œä¸“æ³¨å†™ä½œ
                
                const user = ref(null);
                const notes = ref([]);
                const folders = ref([]);
                const currentNote = ref({});
                const decryptedContent = ref(null); // å†…å­˜ä¸­çš„æ˜æ–‡
                const saveStatus = ref('å·²åŒæ­¥');
                
                const mode = ref('login');
                const authForm = ref({ username: '', password: '', inviteCode: '' });

                // å¯†ç è¾“å…¥ç›¸å…³
                const pwdModal = ref({ show: false, mode: 'encrypt', input: '' });
                const currentNotePwd = ref(''); // ä¸´æ—¶å­˜å‚¨å½“å‰ç¬”è®°çš„å¯†ç ï¼Œç”¨äºè‡ªåŠ¨ä¿å­˜æ—¶æŒç»­åŠ å¯†

                // ç®¡ç†ä¸åˆ†äº«
                const showAdminPanel = ref(false);
                const adminUsers = ref([]);
                const shareModal = ref({ show: false, noteId: null, days: 7, pwd: '', burn: false, result: '' });

                const rootFolders = computed(() => folders.value.filter(f => !f.parent_id));
                const getSubFolders = (pid) => folders.value.filter(f => f.parent_id === pid);
                const previewHtml = computed(() => marked.parse(currentNote.value.content || ''));

                onMounted(() => {
                    const saved = localStorage.getItem('baynotes_user');
                    if(saved) { user.value = JSON.parse(saved); loadData(); }
                });

                watch(showAdminPanel, (val) => { if(val) fetchAdminUsers(); });

                const api = async (url, opts={}) => {
                    const token = localStorage.getItem('baynotes_token');
                    if(!token) return logout();
                    opts.headers = { ...opts.headers, 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
                    const res = await fetch(url, opts);
                    if(res.status === 401) logout();
                    return res;
                };

                const loadData = async () => {
                    await api('/api/folders').then(r=>r.json()).then(d=>folders.value=d);
                    fetchNotes();
                };

                const fetchNotes = async () => {
                    let url = `/api/notes?type=${currentView.value}`;
                    if(currentView.value === 'folder') url += `&folderId=${currentFolderId.value}`;
                    if(currentView.value === 'search') url += `&q=${searchQuery.value}`;
                    const res = await api(url);
                    if(res.ok) notes.value = await res.json();
                };

                const setView = (v, id=null) => { currentView.value=v; currentFolderId.value=id; currentNote.value={}; fetchNotes(); };
                const doSearch = () => { searchQuery.value=''; setView('search'); };
                const getViewTitle = () => {
                    if(currentView.value === 'all') return 'å…¨éƒ¨ç¬”è®°';
                    if(currentView.value === 'trash') return 'å›æ”¶ç«™';
                    if(currentView.value === 'shared') return 'æˆ‘çš„åˆ†äº«';
                    if(currentView.value === 'search') return 'æœç´¢ç»“æœ';
                    const f = folders.value.find(f=>f.id===currentFolderId.value);
                    return f ? f.name : 'æ–‡ä»¶å¤¹';
                };
                const getFolderName = (id) => { const f = folders.value.find(x=>x.id===id); return f?f.name:'...'; };
                const formatDate = (ts) => new Date(ts*1000).toLocaleString();

                // === æ ¸å¿ƒé€»è¾‘ï¼šåŠ å¯†ä¸è§£å¯† ===
                
                const selectNote = (note) => {
                    currentNote.value = { ...note };
                    decryptedContent.value = null; // é‡ç½®
                    currentNotePwd.value = '';     // é‡ç½®å¯†ç ç¼“å­˜
                    
                    // å¦‚æœç¬”è®°æœªåŠ å¯†ï¼Œç›´æ¥æ˜¾ç¤ºå†…å®¹
                    if(!note.is_encrypted) {
                        decryptedContent.value = note.content; 
                    }
                    // å¦‚æœå·²åŠ å¯†ï¼ŒcurrentNote.content é‡Œå­˜çš„æ˜¯å¯†æ–‡ï¼ŒdecryptedContent ä¸º null
                    // æ­¤æ—¶ç•Œé¢ä¼šæ˜¾ç¤ºâ€œè¾“å…¥å¯†ç æŸ¥çœ‹â€
                };

                const toggleEncryption = () => {
                    if(currentNote.value.is_encrypted) {
                        // å°è¯•å…³é—­åŠ å¯†ï¼šéœ€è¦éªŒè¯å½“å‰æ˜¯å¦å·²è§£å¯†
                        if(!decryptedContent.value) { alert("è¯·å…ˆè§£å¯†ç¬”è®°ï¼"); return; }
                        if(confirm("ç¡®å®šè¦ç§»é™¤åŠ å¯†ä¿æŠ¤å—ï¼Ÿå†…å®¹å°†å˜ä¸ºæ˜æ–‡å­˜å‚¨ã€‚")) {
                            currentNote.value.is_encrypted = 0;
                            currentNote.value.content = decryptedContent.value;
                            currentNotePwd.value = '';
                            saveNote();
                        }
                    } else {
                        // å¼€å¯åŠ å¯†
                        pwdModal.value = { show: true, mode: 'encrypt', input: '' };
                    }
                };

                const promptDecrypt = () => {
                    pwdModal.value = { show: true, mode: 'decrypt', input: '' };
                };

                const handlePwdSubmit = () => {
                    const pwd = pwdModal.value.input;
                    if(!pwd) return;

                    if(pwdModal.value.mode === 'encrypt') {
                        // æ‰§è¡ŒåŠ å¯†
                        currentNotePwd.value = pwd;
                        const ciphertext = CryptoJS.AES.encrypt(currentNote.value.content, pwd).toString();
                        currentNote.value.content = ciphertext;
                        currentNote.value.is_encrypted = 1;
                        decryptedContent.value = null; // åŠ å¯†åï¼Œå†…å­˜ä¸­ä¸´æ—¶ä¸æ˜¾ç¤ºæ˜æ–‡ï¼Œæˆ–è€…ä½ å¯ä»¥é€‰æ‹©è®©å®ƒç»§ç»­æ˜¾ç¤º
                        saveNote(); // ä¿å­˜å¯†æ–‡
                        // åŠ å¯†å®Œæˆåï¼Œå®é™…ä¸Šç”¨æˆ·è¿˜åœ¨ç¼–è¾‘ç•Œé¢ï¼Œä¸ºäº†ä½“éªŒå¥½ï¼Œå¯ä»¥ä¿ç•™ decryptedContent
                        // è¿™é‡Œä¸ºäº†å®‰å…¨ï¼Œå…ˆå¼ºåˆ¶è®©ç”¨æˆ·é‡æ–°è¾“å…¥ä¸€æ¬¡æˆ–è€…é»˜è®¤å·²éªŒè¯
                        // ç®€å•å¤„ç†ï¼šåŠ å¯†åè®¤ä¸ºå·²æˆæƒï¼Œä¿ç•™æ˜æ–‡åœ¨ view ä¸­
                        const bytes = CryptoJS.AES.decrypt(ciphertext, pwd);
                        decryptedContent.value = bytes.toString(CryptoJS.enc.Utf8);
                    } else {
                        // æ‰§è¡Œè§£å¯†
                        try {
                            const bytes = CryptoJS.AES.decrypt(currentNote.value.content, pwd);
                            const original = bytes.toString(CryptoJS.enc.Utf8);
                            if(!original) throw new Error();
                            
                            decryptedContent.value = original;
                            currentNote.value.content = original; // è§†å›¾å±‚ä½¿ç”¨ content ç»‘å®š textarea
                            currentNotePwd.value = pwd; // ç¼“å­˜å¯†ç ç”¨äºåç»­ä¿å­˜
                        } catch(e) {
                            alert("å¯†ç é”™è¯¯ï¼Œè§£å¯†å¤±è´¥");
                            return;
                        }
                    }
                    pwdModal.value.show = false;
                };

                // === ä¿å­˜é€»è¾‘ ===
                let timeout;
                const debouncedSave = () => {
                    saveStatus.value = '...';
                    clearTimeout(timeout);
                    timeout = setTimeout(saveNote, 800);
                };

                const saveNote = async () => {
                    if(!currentNote.value.title) return;
                    
                    let contentToSend = currentNote.value.content;

                    // å¦‚æœæ˜¯åŠ å¯†ç¬”è®°ï¼Œä¿å­˜å‰å¿…é¡»å†æ¬¡åŠ å¯†
                    if(currentNote.value.is_encrypted) {
                        if(!currentNotePwd.value) {
                            // æç«¯æƒ…å†µï¼šç”¨æˆ·è§£å¯†äº†ï¼Œä½†å¯†ç ç¼“å­˜ä¸¢äº†ï¼ˆä¸å¤ªå¯èƒ½å‘ç”Ÿï¼Œé™¤éåˆ·æ–°é¡µé¢ï¼‰
                            // æ­¤æ—¶ä¸èƒ½ä¿å­˜æ˜æ–‡ï¼Œåªèƒ½æŠ¥é”™é˜»æ­¢
                            saveStatus.value = 'ä¿å­˜å¤±è´¥ï¼šå¯†é’¥ä¸¢å¤±';
                            return; 
                        }
                        contentToSend = CryptoJS.AES.encrypt(currentNote.value.content, currentNotePwd.value).toString();
                    }

                    const payload = { ...currentNote.value, content: contentToSend };
                    
                    const res = await api('/api/notes', { method: 'POST', body: JSON.stringify(payload) });
                    if(res.ok) {
                        const data = await res.json();
                        if(!currentNote.value.id) {
                            currentNote.value.id = data.id;
                            notes.value.unshift(currentNote.value);
                        }
                        // æ›´æ–°åˆ—è¡¨ä¸­çš„æ‘˜è¦ï¼ˆä¿å­˜å¯†æ–‡ï¼‰
                        const idx = notes.value.findIndex(n=>n.id===currentNote.value.id);
                        if(idx!==-1) {
                            notes.value[idx].title = currentNote.value.title;
                            notes.value[idx].content = contentToSend; 
                            notes.value[idx].is_encrypted = currentNote.value.is_encrypted;
                        }
                        saveStatus.value = 'å·²åŒæ­¥';
                    }
                };
                
                // å…¶ä»–è¾…åŠ©å‡½æ•° (æ–‡ä»¶å¤¹ã€åˆ é™¤ã€åˆ†äº«ç­‰) ä¿æŒåŸæœ‰é€»è¾‘ï¼Œç•¥å¾®é€‚é… UI
                const initNewNote = () => { 
                    currentNote.value = { title: '', content: '', is_encrypted: 0, folderId: currentView.value==='folder'?currentFolderId.value:null }; 
                    decryptedContent.value = '';
                    currentNotePwd.value = '';
                };
                const createFolder = async (pid) => { const n=prompt("æ–‡ä»¶å¤¹å"); if(n) { await api('/api/folders', {method:'POST', body:JSON.stringify({name:n, parentId:pid})}); loadData(); }};
                const deleteFolder = async (id) => { if(confirm("åˆ é™¤?")) { await api(`/api/folders?id=${id}`, {method:'DELETE'}); loadData(); }};
                const deleteNote = async (n) => { if(confirm("åˆ é™¤?")) { await api(`/api/notes?id=${n.id}${currentView.value==='trash'?'&type=hard':''}`, {method:'DELETE'}); fetchNotes(); if(currentNote.value.id===n.id) currentNote.value={}; }};
                const restoreNote = async (n) => { alert("è¯·æ–°å»ºç¬”è®°å¤åˆ¶å†…å®¹ (APIé™åˆ¶)"); };
                
                // åˆ†äº«
                const openShare = (n) => { shareModal.value.noteId=n.id; shareModal.value.show=true; };
                const doShare = async () => {
                    const res = await api('/api/notes', {method:'PATCH', body:JSON.stringify(shareModal.value)});
                    const d = await res.json();
                    shareModal.value.result = `${window.location.origin}/view.html?id=${d.shareId}`;
                    currentNote.value.share_id = d.shareId;
                };

                // Auth & Admin
                const handleAuth = async () => {
                    try {
                        const res = await fetch('/api/auth', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({action:mode.value, ...authForm.value})});
                        const data = await res.json();
                        if(!res.ok) throw new Error(data.error);
                        if(mode.value==='register') { alert("æ³¨å†ŒæˆåŠŸ"); mode.value='login'; }
                        else { user.value=data.user; localStorage.setItem('baynotes_user', JSON.stringify(data.user)); localStorage.setItem('baynotes_token', data.token); loadData(); }
                    } catch(e) { alert(e.message); }
                };
                const logout = () => { localStorage.clear(); user.value=null; };
                const fetchAdminUsers = async () => { const r=await api('/api/admin'); if(r.ok) adminUsers.value=await r.json(); };
                const resetPwd = async (u) => { const p=prompt("New Pwd"); if(p) api('/api/admin', {method:'POST', body:JSON.stringify({targetUserId:u.id, action:'reset_password', newPassword:p})}); };
                const delUser = async (u) => { if(confirm("Del?")) { await api(`/api/admin?id=${u.id}`, {method:'DELETE'}); fetchAdminUsers(); }};

                return {
                    sidebarOpen, currentView, currentFolderId, searchQuery, showPreview, user, notes, folders, rootFolders, getSubFolders, currentNote, decryptedContent, saveStatus,
                    mode, authForm, pwdModal, showAdminPanel, adminUsers, shareModal, previewHtml,
                    setView, doSearch, getViewTitle, getFolderName, formatDate, selectNote, toggleEncryption, promptDecrypt, handlePwdSubmit, debouncedSave, initNewNote, createFolder, deleteFolder, deleteNote, restoreNote, openShare, doShare, handleAuth, logout, resetPwd, delUser, fetchAdminUsers
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
