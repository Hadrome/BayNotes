<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BayNotes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* ä¾§è¾¹æ åŠ¨ç”» */
        .sidebar-transition { transition: width 0.3s ease, opacity 0.3s ease, transform 0.3s ease; }
        
        .sidebar-item { 
            @apply flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer text-slate-500 hover:bg-gray-100 hover:text-slate-900 transition-colors text-sm font-medium select-none; 
        }
        .sidebar-item.active { @apply bg-white text-blue-600 shadow-sm ring-1 ring-gray-200; }
        
        .note-item { @apply p-3 rounded-lg cursor-pointer border border-transparent hover:bg-white hover:shadow-sm transition mb-1 group relative; }
        .note-item.active { @apply bg-white border-gray-200 shadow-md ring-1 ring-black/5 z-10; }

        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .editor-title { @apply text-3xl font-bold text-slate-800 outline-none mb-4 bg-transparent w-full; }
        .editor-content { @apply flex-1 w-full outline-none resize-none text-slate-700 leading-7 bg-transparent font-mono text-sm; }
        
        .toolbar-btn { @apply p-1.5 rounded hover:bg-gray-100 text-slate-400 hover:text-slate-700 transition; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-white text-slate-800 h-screen flex overflow-hidden selection:bg-blue-100">
    
    <div id="app" class="w-full h-full flex relative">

        <div v-if="appLoading" class="fixed inset-0 z-[200] bg-white flex items-center justify-center">
            <i class="ph ph-spinner spin text-2xl text-slate-400"></i>
        </div>

        <div v-if="!user && !appLoading" class="absolute inset-0 z-[100] flex items-center justify-center bg-gray-50/95 backdrop-blur-sm">
            <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl border border-gray-100 p-8">
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-bold text-slate-800">BayNotes</h1>
                    <p class="text-slate-400 text-xs mt-1">æç®€äº‘ç¬”è®°</p>
                </div>
                <div class="space-y-4">
                    <input v-model="authForm.username" @keyup.enter="handleAuth" placeholder="ç”¨æˆ·å" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm outline-none focus:border-blue-500">
                    <input v-model="authForm.password" @keyup.enter="handleAuth" type="password" placeholder="å¯†ç " class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm outline-none focus:border-blue-500">
                    <input v-if="mode==='register'" v-model="authForm.inviteCode" placeholder="é‚€è¯·ç " class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm outline-none focus:border-blue-500">
                    <button @click="handleAuth" :disabled="authLoading" class="w-full bg-slate-900 text-white py-3 rounded-xl text-sm font-bold flex justify-center items-center gap-2 hover:bg-slate-800 transition">
                        <i v-if="authLoading" class="ph ph-spinner spin"></i> {{ mode==='login'?'ç™»å½•':'æ³¨å†Œ' }}
                    </button>
                    <button type="button" @click="mode=mode==='login'?'register':'login'" class="w-full text-center text-xs text-slate-400 hover:text-slate-600 underline decoration-dotted pt-2">
                        {{ mode==='login'?'åˆ›å»ºæ–°è´¦å·':'è¿”å›ç™»å½•' }}
                    </button>
                </div>
            </div>
        </div>

        <template v-else-if="user">
            <aside :class="sidebarOpen ? 'w-64 opacity-100 translate-x-0' : 'w-0 opacity-0 -translate-x-full overflow-hidden'" class="sidebar-transition flex-shrink-0 bg-[#F7F7F5] border-r border-gray-200 flex flex-col relative z-20">
                
                <div class="p-4 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-slate-800 text-white flex items-center justify-center text-sm font-bold">{{ user.username[0].toUpperCase() }}</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-bold truncate text-slate-700">{{ user.username }}</div>
                        <div class="text-[10px] text-slate-400">{{ user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·' }}</div>
                    </div>
                </div>

                <div class="px-4 mb-2">
                    <button @click="initNewNote" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-200 text-slate-600 py-2 rounded-lg hover:shadow-md hover:border-blue-300 transition group">
                        <i class="ph ph-plus-circle text-lg text-blue-500 group-hover:scale-110 transition"></i>
                        <span class="text-sm font-medium">æ–°å»ºç¬”è®°</span>
                    </button>
                </div>

                <div class="px-3 flex-1 overflow-y-auto custom-scroll">
                    <div @click="doSearch" :class="{active: currentView==='search'}" class="sidebar-item mb-4">
                        <i class="ph ph-magnifying-glass text-lg"></i> æœç´¢
                    </div>

                    <div class="space-y-0.5">
                        <div @click="setView('all')" :class="{active: currentView==='all'}" class="sidebar-item">
                            <i class="ph ph-house"></i> å…¨éƒ¨ç¬”è®°
                        </div>
                        <div @click="setView('shared')" :class="{active: currentView==='shared'}" class="sidebar-item">
                            <i class="ph ph-share-network"></i> æˆ‘çš„åˆ†äº«
                        </div>
                        <div @click="setView('trash')" :class="{active: currentView==='trash'}" class="sidebar-item group justify-between">
                            <span class="flex items-center gap-2"><i class="ph ph-trash"></i> å›æ”¶ç«™</span>
                            <span v-if="trashCount > 0" class="text-[10px] bg-red-100 text-red-600 px-1.5 rounded-full font-bold">{{trashCount}}</span>
                        </div>
                    </div>

                    <div class="mt-6 px-3 mb-1 text-xs font-bold text-slate-400 uppercase flex justify-between group">
                        <span>æ–‡ä»¶å¤¹</span>
                        <i @click.stop="createFolder(null)" class="ph ph-plus cursor-pointer hover:text-slate-800 opacity-0 group-hover:opacity-100 transition" title="æ–°å»ºæ ¹æ–‡ä»¶å¤¹"></i>
                    </div>
                    
                    <div class="space-y-0.5 pb-10">
                        <div v-for="folder in rootFolders" :key="folder.id">
                            <div @click="setView('folder', folder.id)" :class="{active: currentView === 'folder' && currentFolderId === folder.id}" class="sidebar-item justify-between group">
                                <span class="flex items-center gap-2 truncate text-slate-700"><i class="ph ph-folder"></i> {{ folder.name }}</span>
                                <div class="hidden group-hover:flex gap-1 text-slate-400">
                                    <i @click.stop="createFolder(folder.id)" class="ph ph-plus hover:text-slate-800 p-1 hover:bg-gray-200 rounded" title="æ–°å»ºå­æ–‡ä»¶å¤¹"></i>
                                    <i @click.stop="deleteFolder(folder.id)" class="ph ph-x hover:text-red-500 p-1 hover:bg-gray-200 rounded"></i>
                                </div>
                            </div>
                            <div v-for="sub in getSubFolders(folder.id)" :key="sub.id" @click="setView('folder', sub.id)" :class="{active: currentView === 'folder' && currentFolderId === sub.id}" class="sidebar-item pl-8 text-xs group justify-between">
                                <span class="truncate flex items-center gap-2 border-l-2 border-gray-200 pl-2">{{ sub.name }}</span>
                                <i @click.stop="deleteFolder(sub.id)" class="ph ph-x hidden group-hover:block hover:text-red-500 text-slate-400 p-1"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-3 border-t border-gray-200 bg-gray-50">
                     <div v-if="user.role === 'admin'" @click="showAdminPanel=true" class="sidebar-item text-xs hover:text-blue-600">
                        <i class="ph ph-shield-check"></i> ç®¡ç†å‘˜é¢æ¿
                    </div>
                    <div @click="logout" class="sidebar-item text-xs hover:text-red-600">
                        <i class="ph ph-sign-out"></i> é€€å‡ºç™»å½•
                    </div>
                </div>
            </aside>

            <div class="w-72 flex-shrink-0 border-r border-gray-200 flex flex-col bg-[#FCFBF9] transition-all"> 
                <div class="h-12 flex items-center px-4 border-b border-gray-100 justify-between shrink-0 bg-white/60 backdrop-blur sticky top-0 z-10">
                    <span class="font-bold text-sm text-slate-700 flex items-center gap-2">
                        <button v-if="!sidebarOpen" @click="sidebarOpen=true"><i class="ph ph-list"></i></button>
                        {{ getViewTitle() }}
                    </span>
                    <button @click="initNewNote" class="text-slate-400 hover:text-blue-600 transition"><i class="ph ph-plus text-lg"></i></button>
                </div>
                
                <div v-if="currentView === 'search'" class="p-3 border-b border-gray-100">
                    <div class="relative">
                        <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
                        <input ref="searchInputRef" v-model="searchQuery" @keyup.enter="fetchNotes" placeholder="æœç´¢å†…å®¹..." class="w-full text-xs bg-white border border-gray-200 rounded-lg py-2 pl-8 pr-2 outline-none focus:border-blue-500">
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scroll p-2 space-y-1">
                    <div v-if="listLoading" class="flex justify-center py-4"><i class="ph ph-spinner spin text-slate-400"></i></div>
                    <template v-else>
                        <div v-for="note in notes" :key="note.id" @click="selectNote(note)" :class="currentNote && currentNote.id === note.id ? 'active' : ''" class="note-item group">
                            <div class="flex items-center gap-2 mb-1">
                                <i v-if="note.is_encrypted" class="ph ph-lock-key-fill text-yellow-500 text-[10px]"></i>
                                <h4 class="font-medium text-sm truncate text-slate-700 flex-1">{{ note.title || 'æ— æ ‡é¢˜' }}</h4>
                                <span class="text-[10px] text-slate-300">{{ formatDateShort(note.created_at) }}</span>
                            </div>
                            <p class="text-xs text-slate-400 line-clamp-2">{{ note.is_encrypted ? 'ğŸ™ˆ å†…å®¹å·²éšè—' : (note.content || 'æ— å†…å®¹...') }}</p>
                            
                            <div class="absolute right-2 top-2 hidden group-hover:flex bg-white shadow-sm border border-gray-100 rounded ring-1 ring-black/5">
                                <button v-if="currentView==='trash'" @click.stop="restoreNote(note)" class="p-1.5 text-green-600 hover:bg-green-50" title="æ¢å¤"><i class="ph ph-arrow-u-up-left"></i></button>
                                <button @click.stop="deleteNote(note)" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50" title="åˆ é™¤"><i class="ph ph-trash"></i></button>
                            </div>
                        </div>
                        <div v-if="notes.length === 0" class="text-center text-slate-300 mt-20 text-xs">ç©ºç©ºå¦‚ä¹Ÿ</div>
                    </template>
                </div>
            </div>

            <main class="flex-1 flex flex-col bg-white min-w-0 relative">
                <header class="h-12 border-b border-gray-100 flex items-center justify-between px-6 shrink-0 z-10">
                    <div class="flex items-center gap-2 text-xs text-slate-400">
                        <button @click="sidebarOpen = !sidebarOpen" class="hover:text-slate-800 mr-2 transition"><i class="ph ph-arrows-left-right text-lg"></i></button>
                        <span>{{ currentNote && currentNote.folderId ? getFolderName(currentNote.folderId) : 'æ ¹ç›®å½•' }}</span>
                    </div>
                    <div v-if="hasActiveNote && currentView !== 'trash'" class="flex items-center gap-3">
                         <span class="text-[10px] uppercase font-bold" :class="saveStatus==='å·²åŒæ­¥'?'text-slate-300':'text-blue-500'">{{ saveStatus }}</span>
                         <div class="h-4 w-px bg-gray-200"></div>
                         <button @click="toggleEncryption" :class="currentNote.is_encrypted ? 'text-yellow-600 bg-yellow-50' : 'text-slate-400 hover:text-slate-600'" class="px-2 py-1 rounded text-xs border border-transparent transition"><i class="ph ph-lock-key"></i> {{ currentNote.is_encrypted ? 'å·²åŠ å¯†' : 'åŠ å¯†' }}</button>
                         <button @click="openShare(currentNote)" :class="currentNote.share_id ? 'text-blue-600 bg-blue-50' : 'text-slate-400 hover:text-slate-600'" class="px-2 py-1 rounded text-xs border border-transparent transition"><i class="ph ph-share-network"></i> {{ currentNote.share_id ? 'å·²åˆ†äº«' : 'åˆ†äº«' }}</button>
                    </div>
                </header>

                <div v-if="hasActiveNote && currentView !== 'trash'" class="flex-1 flex flex-col relative overflow-hidden">
                    <div v-if="currentNote.is_encrypted && !isDecryptedSession" class="absolute inset-0 z-20 bg-white flex flex-col items-center justify-center">
                        <i class="ph ph-lock-key text-4xl text-yellow-500 mb-2"></i>
                        <p class="text-slate-500 text-sm mb-4">å†…å®¹å·²åŠ å¯†</p>
                        <button @click="promptDecrypt" class="bg-slate-900 text-white px-4 py-2 rounded text-sm">è¾“å…¥å¯†ç è§£é”</button>
                    </div>
                    
                    <div class="flex-1 flex flex-col h-full">
                        <div class="h-9 border-b border-gray-100 flex items-center px-6 gap-1 shrink-0 bg-gray-50/50">
                            <button @click="insertFormat('**', '**')" class="toolbar-btn"><i class="ph ph-text-b"></i></button>
                            <button @click="insertFormat('# ', '')" class="toolbar-btn"><i class="ph ph-text-h-one"></i></button>
                            <button @click="insertFormat('- ', '')" class="toolbar-btn"><i class="ph ph-list-dashes"></i></button>
                            <button @click="showPreview = !showPreview" :class="showPreview ? 'text-blue-600 bg-blue-50' : ''" class="toolbar-btn ml-auto"><i class="ph ph-eye"></i></button>
                        </div>
                        <div class="flex-1 flex flex-row overflow-hidden relative">
                            <div class="flex-1 flex flex-col max-w-4xl mx-auto w-full px-8 py-8 h-full overflow-y-auto custom-scroll">
                                <input v-model="currentNote.title" @input="debouncedSave" placeholder="æ— æ ‡é¢˜" class="editor-title">
                                <textarea id="mainEditor" v-model="currentNote.content" @input="debouncedSave" @keydown.tab.prevent="handleTab" placeholder="å¼€å§‹è®°å½•..." class="editor-content custom-scroll"></textarea>
                            </div>
                            <div v-if="showPreview" class="hidden lg:block w-1/2 border-l border-gray-100 bg-gray-50 p-8 overflow-y-auto custom-scroll">
                                <div class="prose prose-sm prose-slate max-w-none" v-html="previewHtml"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="flex-1 flex flex-col items-center justify-center text-slate-300">
                    <i class="ph ph-pencil-slash text-4xl mb-2"></i>
                    <p class="text-xs">é€‰æ‹©ç¬”è®°å¼€å§‹ç¼–è¾‘</p>
                </div>
            </main>
        </template>

        <div v-if="pwdModal.show" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/30 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-xl w-80 shadow-2xl">
                <h3 class="font-bold mb-4 text-center">{{ pwdModal.mode === 'encrypt' ? 'è®¾ç½®å¯†ç ' : 'è§£é”ç¬”è®°' }}</h3>
                <input type="password" v-model="pwdModal.input" @keyup.enter="handlePwdSubmit" autofocus class="w-full border p-2 rounded mb-4 text-sm">
                <div class="flex gap-2"><button @click="pwdModal.show=false" class="flex-1 py-2 text-slate-500 bg-gray-100 rounded text-sm">å–æ¶ˆ</button><button @click="handlePwdSubmit" class="flex-1 py-2 bg-slate-900 text-white rounded text-sm">ç¡®å®š</button></div>
            </div>
        </div>

        <div v-if="shareModal.show" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/30 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-xl w-96 shadow-xl border border-gray-100">
                <div class="flex justify-between mb-4"><h3 class="font-bold flex gap-2 items-center"><i class="ph ph-share-network"></i> åˆ†äº«</h3><button @click="shareModal.show=false"><i class="ph ph-x"></i></button></div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded"><label>æœ‰æ•ˆæœŸ (å¤©)</label><input v-model="shareModal.days" type="number" class="border p-1 w-16 text-center rounded"></div>
                    <input v-model="shareModal.pwd" placeholder="è®¿é—®å¯†ç  (å¯é€‰)" class="w-full border p-2 rounded bg-gray-50">
                    <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" v-model="shareModal.burn" class="accent-red-500"> <span :class="shareModal.burn?'text-red-500':''">é˜…åå³ç„š</span></label>
                    <button @click="doShare" class="w-full bg-blue-600 text-white py-2 rounded font-bold">ç”Ÿæˆé“¾æ¥</button>
                    <div v-if="shareModal.result" class="bg-green-50 p-3 rounded border border-green-100 mt-2"><p class="text-[10px] text-green-600 font-bold">LINK:</p><p class="text-xs break-all select-all font-mono">{{ shareModal.result }}</p></div>
                </div>
            </div>
        </div>

        <div v-if="showAdminPanel" class="fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
             <div class="bg-white w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h2 class="font-bold flex items-center gap-2"><i class="ph ph-shield-check text-blue-600"></i> ç”¨æˆ·ç®¡ç†</h2>
                    <button @click="showAdminPanel=false"><i class="ph ph-x text-lg"></i></button>
                </div>
                <div class="flex-1 overflow-auto bg-gray-50/50">
                    <div v-for="u in adminUsers" :key="u.id" class="bg-white border-b border-gray-100 p-4 hover:bg-gray-50 transition">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="font-bold text-slate-700">{{u.username}}</span>
                                <span :class="u.role==='admin'?'bg-purple-100 text-purple-700':'bg-gray-100 text-slate-500'" class="ml-2 text-[10px] px-2 py-0.5 rounded-full font-bold uppercase">{{u.role}}</span>
                            </div>
                            <div class="flex gap-2 text-xs">
                                <button @click="resetPwd(u)" class="text-blue-600 hover:underline">é‡ç½®å¯†ç </button>
                                <button v-if="u.role!=='admin'" @click="delUser(u)" class="text-red-500 hover:underline">åˆ é™¤ç”¨æˆ·</button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-3 text-xs">
                            <div class="text-slate-400 mb-2 font-bold uppercase tracking-wider">æƒé™é…ç½®</div>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" :checked="hasPerm(u,'edit')" @change="togglePerm(u,'edit')"> ç¼–è¾‘</label>
                                <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" :checked="hasPerm(u,'delete')" @change="togglePerm(u,'delete')"> åˆ é™¤</label>
                                <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" :checked="hasPerm(u,'share')" @change="togglePerm(u,'share')"> åˆ†äº«</label>
                                <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" :checked="hasPerm(u,'burn')" @change="togglePerm(u,'burn')"> é˜…åå³ç„š</label>
                            </div>
                        </div>
                    </div>
                </div>
             </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
        createApp({
            setup() {
                const appLoading = ref(true);
                const authLoading = ref(false);
                const listLoading = ref(false);
                const sidebarOpen = ref(window.innerWidth > 768);
                const currentView = ref('all');
                const currentFolderId = ref(null);
                const searchQuery = ref('');
                const showPreview = ref(false); 
                const searchInputRef = ref(null);
                
                const user = ref(null);
                const notes = ref([]);
                const folders = ref([]);
                const currentNote = ref(null);
                const isDecryptedSession = ref(false); 
                const saveStatus = ref('å·²åŒæ­¥');
                
                const mode = ref('login');
                const authForm = ref({ username: '', password: '', inviteCode: '' });
                const pwdModal = ref({ show: false, mode: 'encrypt', input: '' });
                const currentNotePwd = ref('');
                
                const showAdminPanel = ref(false);
                const adminUsers = ref([]);
                const shareModal = ref({ show: false, noteId: null, days: 7, pwd: '', burn: false, result: '' });

                const rootFolders = computed(() => folders.value.filter(f => !f.parent_id));
                const getSubFolders = (pid) => folders.value.filter(f => f.parent_id === pid);
                const previewHtml = computed(() => currentNote.value ? marked.parse(currentNote.value.content || '') : '');
                const hasActiveNote = computed(() => currentNote.value && (currentNote.value.id || currentNote.value.isNew));
                const trashCount = computed(() => 0); // åç«¯å¯è¡¥å……è®¡æ•°æ¥å£ä¼˜åŒ–ä½“éªŒ

                onMounted(async () => {
                    const saved = localStorage.getItem('baynotes_user');
                    if(saved) { try { user.value = JSON.parse(saved); await loadData(); } catch(e) { logout(); } }
                    appLoading.value = false;
                });

                watch(showAdminPanel, (val) => { if(val) fetchAdminUsers(); });

                const api = async (url, opts={}) => {
                    const token = localStorage.getItem('baynotes_token');
                    if(!token) { logout(); return { ok: false }; }
                    opts.headers = { ...opts.headers, 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
                    try {
                        const res = await fetch(url, opts);
                        if(res.status === 401) { alert("Session Expired"); logout(); return { ok: false }; }
                        return res;
                    } catch (e) { return { ok: false }; }
                };

                const loadData = async () => {
                    try { const r = await api('/api/folders'); if(r.ok) folders.value = await r.json(); } catch(e){}
                    await fetchNotes();
                };

                const fetchNotes = async () => {
                    listLoading.value = true;
                    if(currentView.value === 'search' && !searchQuery.value.trim()) { notes.value = []; listLoading.value=false; return; }
                    let url = `/api/notes?type=${currentView.value}`;
                    if(currentView.value === 'folder') url += `&folderId=${currentFolderId.value}`;
                    if(currentView.value === 'search') url += `&q=${encodeURIComponent(searchQuery.value)}`;
                    const res = await api(url);
                    if(res.ok) notes.value = await res.json();
                    listLoading.value = false;
                };

                const setView = (v, id=null) => { 
                    currentView.value=v; currentFolderId.value=id; currentNote.value=null;
                    if(v!=='search') searchQuery.value=''; 
                    fetchNotes(); 
                    if(window.innerWidth < 768) sidebarOpen.value = false;
                };

                const doSearch = () => { searchQuery.value=''; currentView.value='search'; currentNote.value=null; notes.value=[]; nextTick(()=>searchInputRef.value?.focus()); };
                
                // Auth
                const handleAuth = async () => {
                    if(!authForm.value.username || !authForm.value.password) return alert("è¾“å…¥è´¦å·å¯†ç ");
                    authLoading.value = true;
                    try {
                        const res = await fetch('/api/auth', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:mode.value, ...authForm.value})});
                        const data = await res.json();
                        if(!res.ok) throw new Error(data.error);
                        if(mode.value==='register') { alert("æ³¨å†ŒæˆåŠŸ"); mode.value='login'; }
                        else { 
                            localStorage.setItem('baynotes_token', data.token); localStorage.setItem('baynotes_user', JSON.stringify(data.user)); 
                            user.value = data.user; await nextTick(); loadData();
                        }
                    } catch(e) { alert(e.message); } finally { authLoading.value = false; }
                };
                const logout = () => { localStorage.clear(); user.value=null; notes.value=[]; };

                // Note Ops
                const initNewNote = () => {
                    currentNote.value = { isNew: true, title: '', content: '', is_encrypted: 0, folderId: currentView.value==='folder' ? currentFolderId.value : null };
                    isDecryptedSession.value = true; currentNotePwd.value = '';
                    if(window.innerWidth < 768) sidebarOpen.value = false;
                };
                const selectNote = (n) => { currentNote.value={...n}; currentNotePwd.value=''; isDecryptedSession.value = !n.is_encrypted; };
                
                const createFolder = async (pid) => { const n=prompt("æ–‡ä»¶å¤¹åç§°"); if(n) { await api('/api/folders', {method:'POST', body:JSON.stringify({name:n, parentId:pid})}); loadData(); }};
                const deleteFolder = async (id) => { if(confirm("ç¡®è®¤åˆ é™¤æ–‡ä»¶å¤¹?")) { await api(`/api/folders?id=${id}`, {method:'DELETE'}); loadData(); if(currentFolderId.value===id) setView('all'); }};
                
                const deleteNote = async (n) => { 
                    if(confirm("ç§»å…¥å›æ”¶ç«™?")) { 
                        await api(`/api/notes?id=${n.id}${currentView.value==='trash'?'&type=hard':''}`, {method:'DELETE'}); 
                        notes.value = notes.value.filter(x=>x.id!==n.id); if(currentNote.value?.id===n.id) currentNote.value=null; 
                    }
                };
                
                // â˜… æ¢å¤ç¬”è®°é€»è¾‘
                const restoreNote = async (n) => {
                    if(confirm("ç¡®å®šæ¢å¤æ­¤ç¬”è®°?")) {
                        // ä½¿ç”¨ PATCH + action='restore'
                        const res = await api('/api/notes', {method:'PATCH', body:JSON.stringify({ noteId: n.id, action: 'restore' })});
                        if(res.ok) {
                            notes.value = notes.value.filter(x=>x.id!==n.id); // ä»å›æ”¶ç«™åˆ—è¡¨ç§»é™¤
                            if(currentNote.value?.id===n.id) currentNote.value=null;
                        } else {
                            alert("æ¢å¤å¤±è´¥");
                        }
                    }
                };

                // Editor & Encryption
                const toggleEncryption = () => { if(currentNote.value.is_encrypted) { if(!isDecryptedSession.value) return alert("å…ˆè§£å¯†"); if(confirm("ç§»é™¤åŠ å¯†?")) { currentNote.value.is_encrypted=0; currentNotePwd.value=''; saveNote(); } } else { pwdModal.value={show:true, mode:'encrypt', input:''}; }};
                const promptDecrypt = () => { pwdModal.value={show:true, mode:'decrypt', input:''}; };
                const handlePwdSubmit = () => {
                    const p = pwdModal.value.input; if(!p) return;
                    if(pwdModal.value.mode==='encrypt') { currentNote.value.is_encrypted=1; currentNotePwd.value=p; isDecryptedSession.value=true; saveNote(); }
                    else {
                        try {
                            const b = CryptoJS.AES.decrypt(currentNote.value.content, p);
                            const o = b.toString(CryptoJS.enc.Utf8); if(!o) throw 1;
                            currentNote.value.content=o; currentNotePwd.value=p; isDecryptedSession.value=true;
                        } catch(e) { return alert("å¯†ç é”™è¯¯"); }
                    }
                    pwdModal.value.show=false; pwdModal.value.input='';
                };

                let timer;
                const debouncedSave = () => { saveStatus.value='åŒæ­¥ä¸­...'; clearTimeout(timer); timer=setTimeout(saveNote, 800); };
                const saveNote = async () => {
                    if(!currentNote.value || (!currentNote.value.title && !currentNote.value.content && currentNote.value.isNew)) return;
                    let c = currentNote.value.content;
                    if(currentNote.value.is_encrypted) {
                        if(!currentNotePwd.value) return saveStatus.value='å¯†é’¥ä¸¢å¤±';
                        c = CryptoJS.AES.encrypt(c, currentNotePwd.value).toString();
                    }
                    const res = await api('/api/notes', {method:'POST', body:JSON.stringify({...currentNote.value, content:c})});
                    if(res.ok) {
                        const d = await res.json();
                        if(currentNote.value.isNew) { currentNote.value.id=d.id; delete currentNote.value.isNew; notes.value.unshift(currentNote.value); }
                        saveStatus.value='å·²åŒæ­¥';
                    } else { saveStatus.value='å¤±è´¥'; }
                };

                const insertFormat = (b, a) => {
                    const t = document.getElementById('mainEditor'); if(!t) return;
                    const s = t.selectionStart, e = t.selectionEnd, v = currentNote.value.content||'';
                    currentNote.value.content = v.substring(0, s) + b + v.substring(s, e) + a + v.substring(e);
                    nextTick(() => { t.focus(); t.selectionStart = s + b.length; t.selectionEnd = e + b.length; });
                    debouncedSave();
                };
                const handleTab = (e) => { insertFormat('  ', ''); }; // ç®€å•æ’å…¥ç©ºæ ¼

                // Share
                const openShare = (n) => { shareModal.value={show:true, noteId:n.id, days:7, pwd:'', burn:false, result:''}; };
                const doShare = async () => {
                    const res = await api('/api/notes', {method:'PATCH', body:JSON.stringify({...shareModal.value, noteId:currentNote.value.id})});
                    const d = await res.json();
                    shareModal.value.result = `${window.location.origin}/view.html?id=${d.shareId}`;
                    currentNote.value.share_id = d.shareId;
                };

                // Admin Logic
                const fetchAdminUsers = async () => { const r=await api('/api/admin'); if(r.ok) adminUsers.value=await r.json(); };
                const resetPwd = async (u) => { const p=prompt("æ–°å¯†ç "); if(p) api('/api/admin', {method:'POST', body:JSON.stringify({targetUserId:u.id, action:'reset_password', newPassword:p})}); };
                const delUser = async (u) => { if(confirm("åˆ ?")) { await api(`/api/admin?id=${u.id}`, {method:'DELETE'}); fetchAdminUsers(); }};
                
                const hasPerm = (u, p) => (u.permissions||'all').includes('all') || (u.permissions||'').includes(p);
                const togglePerm = async (u, p) => {
                    let perms = (u.permissions === 'all' || !u.permissions) ? ['edit','delete','share','burn'] : u.permissions.split(',');
                    if(perms.includes(p)) perms = perms.filter(x=>x!==p); else perms.push(p);
                    const newP = perms.join(',');
                    await api('/api/admin', {method:'POST', body:JSON.stringify({targetUserId:u.id, action:'update_permissions', newPermissions:newP})});
                    u.permissions = newP; // æœ¬åœ°æ›´æ–°UI
                };

                // Utils
                const getViewTitle = () => {
                    const map = {all:'å…¨éƒ¨ç¬”è®°', trash:'å›æ”¶ç«™', shared:'åˆ†äº«ä¸­', search:'æœç´¢'};
                    if(currentView.value in map) return map[currentView.value];
                    const f = folders.value.find(x=>x.id===currentFolderId.value);
                    return f ? f.name : 'æ–‡ä»¶å¤¹';
                };
                const getFolderName = (id) => folders.value.find(x=>x.id===id)?.name || '...';
                const formatDateShort = (ts) => new Date(ts*1000).toLocaleDateString(undefined, {month:'numeric', day:'numeric'});

                return {
                    appLoading, authLoading, listLoading, sidebarOpen, user, notes, rootFolders, getSubFolders, currentNote, hasActiveNote, currentView, searchQuery, showPreview, searchInputRef, saveStatus, trashCount, isDecryptedSession, previewHtml, mode, authForm, pwdModal, shareModal, showAdminPanel, adminUsers,
                    handleAuth, logout, initNewNote, selectNote, createFolder, deleteFolder, deleteNote, restoreNote, toggleEncryption, promptDecrypt, handlePwdSubmit, debouncedSave, insertFormat, handleTab, openShare, doShare, fetchAdminUsers, resetPwd, delUser, setView, doSearch, getViewTitle, getFolderName, formatDateShort, hasPerm, togglePerm
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
