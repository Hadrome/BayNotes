<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BayNotes</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        serif: ['Merriweather', 'ui-serif', 'Georgia', 'Cambria', 'Times New Roman', 'Times', 'serif'],
                    },
                    colors: {
                        notion: {
                            bg: '#FFFFFF',
                            sidebar: '#F7F7F5',
                            hover: '#EFEFEF',
                            text: '#37352F',
                            dim: '#ACABA9'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@300;400;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; color: #37352F; background-color: white; }
        
        /* 自定义滚动条 */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }

        /* 侧边栏动画 */
        .sidebar-item { 
            @apply flex items-center gap-2.5 px-3 py-1.5 rounded-md cursor-pointer text-gray-500 hover:bg-gray-200/60 hover:text-gray-900 transition-colors select-none text-sm font-medium my-0.5; 
        }
        .sidebar-item.active { @apply bg-gray-200 text-gray-900 font-semibold; }
        
        /* 编辑器样式 */
        .editor-textarea {
            @apply w-full resize-none outline-none bg-transparent leading-relaxed text-gray-800 placeholder-gray-300 font-mono text-sm;
            min-height: 60vh;
        }
        
        /* 预览模式下的排版优化 */
        .prose h1 { margin-bottom: 0.5em; }
        .prose p { margin-bottom: 0.8em; }
        .prose pre { background-color: #F7F7F5; border-radius: 4px; color: #37352F; border: 1px solid #E5E5E5; }

        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        [v-cloak] { display: none; }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-blue-100/50 selection:text-blue-900">
    
    <div id="app" v-cloak class="w-full h-full flex relative">

        <div v-if="appLoading" class="fixed inset-0 z-[200] bg-white flex flex-col items-center justify-center gap-3">
            <i class="ph ph-spinner spin text-3xl text-gray-300"></i>
            <span class="text-xs text-gray-400 font-medium tracking-widest uppercase">BayNotes Loading</span>
        </div>

        <div v-if="!user && !appLoading" class="absolute inset-0 z-[100] flex items-center justify-center bg-[#F7F7F5]">
            <div class="w-full max-w-[360px] bg-white rounded-xl shadow-xl border border-gray-100 p-8 transform transition-all">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-xl bg-gray-900 text-white mb-4 shadow-lg">
                        <i class="ph ph-notebook text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800 tracking-tight">BayNotes</h1>
                    <p class="text-gray-400 text-xs mt-2 uppercase tracking-wide">Secure • Minimal • Fast</p>
                </div>
                <div class="space-y-3">
                    <input v-model="authForm.username" @keyup.enter="handleAuth" placeholder="用户名" class="w-full bg-gray-50 border border-gray-200 px-4 py-2.5 rounded-lg text-sm outline-none focus:border-gray-400 focus:bg-white transition placeholder-gray-400">
                    <input v-model="authForm.password" @keyup.enter="handleAuth" type="password" placeholder="密码" class="w-full bg-gray-50 border border-gray-200 px-4 py-2.5 rounded-lg text-sm outline-none focus:border-gray-400 focus:bg-white transition placeholder-gray-400">
                    <input v-if="mode==='register'" v-model="authForm.inviteCode" placeholder="邀请码" class="w-full bg-gray-50 border border-gray-200 px-4 py-2.5 rounded-lg text-sm outline-none focus:border-gray-400 focus:bg-white transition placeholder-gray-400">
                    
                    <button @click="handleAuth" :disabled="authLoading" class="w-full bg-gray-900 text-white py-2.5 rounded-lg text-sm font-semibold flex justify-center items-center gap-2 hover:bg-black transition-all shadow-md active:scale-[0.98]">
                        <i v-if="authLoading" class="ph ph-spinner spin"></i> {{ mode==='login'?'进入工作台':'创建账号' }}
                    </button>
                    
                    <div class="pt-4 text-center">
                         <button type="button" @click="mode=mode==='login'?'register':'login'" class="text-xs text-gray-400 hover:text-gray-600 transition underline decoration-dotted">
                            {{ mode==='login'?'注册新账号':'返回登录' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <template v-else-if="user">
            <aside :class="sidebarOpen ? 'w-60 opacity-100 translate-x-0' : 'w-0 opacity-0 -translate-x-full overflow-hidden'" class="flex-shrink-0 bg-[#F7F7F5] flex flex-col transition-all duration-300 relative z-20 border-r border-gray-200/50">
                
                <div class="p-4 flex items-center gap-3 select-none mb-2">
                    <div class="w-6 h-6 rounded bg-gray-200 text-gray-600 flex items-center justify-center text-xs font-bold">{{ user.username[0].toUpperCase() }}</div>
                    <div class="text-sm font-medium text-gray-700 truncate flex-1">{{ user.username }}</div>
                    <button @click="initNewNote" class="text-gray-400 hover:text-gray-800 transition"><i class="ph ph-plus-circle text-lg"></i></button>
                </div>

                <div class="px-2 flex-1 overflow-y-auto custom-scroll space-y-0.5">
                    <div @click="doSearch" :class="{active: currentView==='search'}" class="sidebar-item">
                        <i class="ph ph-magnifying-glass text-lg"></i> <span class="truncate">搜索</span>
                    </div>
                    <div @click="setView('all')" :class="{active: currentView==='all'}" class="sidebar-item">
                        <i class="ph ph-house text-lg"></i> <span>全部笔记</span>
                    </div>
                    <div @click="setView('trash')" :class="{active: currentView==='trash'}" class="sidebar-item">
                        <i class="ph ph-trash text-lg"></i> <span>回收站</span>
                    </div>

                    <div class="mt-6 px-3 mb-1 text-[11px] font-bold text-gray-400 uppercase flex justify-between group">
                        <span>Folders</span>
                        <i @click.stop="createFolder(null)" class="ph ph-plus cursor-pointer hover:text-gray-900 opacity-0 group-hover:opacity-100 transition" title="新建文件夹"></i>
                    </div>
                    
                    <div v-for="folder in rootFolders" :key="folder.id">
                        <div @click="handleFolderClick(folder)" :class="{active: currentView === 'folder' && currentFolderId === folder.id}" class="sidebar-item justify-between group">
                            <span class="flex items-center gap-2 truncate text-gray-600">
                                <i :class="folder.is_encrypted ? (isFolderUnlocked(folder.id) ? 'ph-folder-open' : 'ph-lock-key-fill text-yellow-600/70') : 'ph-folder'" class="ph text-lg"></i> 
                                {{ folder.name }}
                            </span>
                            <div class="hidden group-hover:flex items-center text-gray-400">
                                <i v-if="folder.is_encrypted && isFolderUnlocked(folder.id)" @click.stop="lockFolder(folder.id)" class="ph ph-lock-open hover:text-yellow-600 p-1" title="锁定"></i>
                                <i @click.stop="createFolder(folder.id)" class="ph ph-plus hover:text-gray-900 p-1"></i>
                                <i @click.stop="deleteFolder(folder.id)" class="ph ph-dots-three hover:text-gray-900 p-1"></i>
                            </div>
                        </div>
                        <div v-for="sub in getSubFolders(folder.id)" :key="sub.id" @click="handleFolderClick(sub)" :class="{active: currentView === 'folder' && currentFolderId === sub.id}" class="sidebar-item pl-8 text-xs group justify-between">
                            <span class="truncate flex items-center gap-2 border-l border-gray-300 pl-2 text-gray-500">
                                <i v-if="sub.is_encrypted" :class="isFolderUnlocked(sub.id)?'ph-lock-open':'ph-lock-key-fill text-yellow-600/70'" class="ph text-xs"></i>
                                {{ sub.name }}
                            </span>
                            <i @click.stop="deleteFolder(sub.id)" class="ph ph-x hidden group-hover:block hover:text-red-500 text-gray-400 p-1"></i>
                        </div>
                    </div>
                </div>

                <div class="p-3 border-t border-gray-200/50">
                    <div @click="logout" class="sidebar-item text-xs hover:bg-red-50 hover:text-red-600 justify-center gap-1">
                        <i class="ph ph-sign-out"></i> 退出
                    </div>
                </div>
            </aside>

            <div class="w-72 flex-shrink-0 border-r border-gray-200/50 flex flex-col bg-white transition-all relative z-10" :class="{'hidden md:flex': hasActiveNote && window.innerWidth < 768}"> 
                <div class="h-12 flex items-center px-4 border-b border-gray-100 justify-between shrink-0 sticky top-0 bg-white/95 backdrop-blur z-10">
                    <span class="font-semibold text-sm text-gray-700 flex items-center gap-2">
                        <button v-if="!sidebarOpen" @click="sidebarOpen=true" class="hover:bg-gray-100 p-1 rounded text-gray-500"><i class="ph ph-list"></i></button>
                        {{ getViewTitle() }}
                    </span>
                    <button @click="initNewNote" class="text-gray-400 hover:text-blue-600 p-1 rounded hover:bg-blue-50 transition"><i class="ph ph-pencil-simple-line text-lg"></i></button>
                </div>
                
                <div v-if="currentView === 'search'" class="p-3 border-b border-gray-50">
                    <div class="relative">
                        <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-gray-400"></i>
                        <input ref="searchInputRef" v-model="searchQuery" @keyup.enter="fetchNotes" placeholder="输入关键词回车..." class="w-full text-sm bg-gray-50 border border-gray-200 rounded-md py-2 pl-9 pr-2 outline-none focus:border-blue-400 transition">
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scroll">
                    <div v-if="listLoading" class="flex justify-center py-10"><i class="ph ph-spinner spin text-gray-300 text-xl"></i></div>
                    
                    <div v-else-if="folderLocked" class="flex flex-col items-center justify-center pt-24 text-gray-400 gap-4 px-6 text-center">
                        <div class="w-16 h-16 rounded-full bg-gray-50 flex items-center justify-center">
                            <i class="ph ph-lock-key text-3xl text-gray-300"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-gray-600 mb-1">已加密</p>
                            <p class="text-xs text-gray-400">此文件夹内容受密码保护</p>
                        </div>
                        <button @click="promptUnlock" class="mt-2 bg-gray-900 text-white px-4 py-1.5 rounded-full text-xs font-bold hover:bg-black transition shadow-sm">点击解锁</button>
                    </div>

                    <template v-else>
                        <div v-for="note in notes" :key="note.id" @click="selectNote(note)" :class="currentNote && currentNote.id === note.id ? 'bg-blue-50 border-blue-200 shadow-sm ring-1 ring-blue-100' : 'border-transparent hover:bg-gray-50'" class="mx-2 my-1 p-3 rounded-lg border cursor-pointer transition-all group relative">
                            <div class="mb-1">
                                <h4 class="font-semibold text-sm truncate text-gray-700 leading-tight" :class="{'text-blue-700': currentNote?.id === note.id}">{{ note.title || '无标题' }}</h4>
                            </div>
                            <p class="text-xs text-gray-400 line-clamp-2 h-8 leading-relaxed mb-2">{{ note.content ? note.content.replace(/[#*`]/g, '') : '写点什么...' }}</p>
                            <div class="flex items-center justify-between text-[10px] text-gray-300">
                                <span>{{ relativeTime(note.created_at) }}</span>
                                <i v-if="note.share_id" class="ph ph-share-network text-blue-400"></i>
                            </div>
                        </div>
                        <div v-if="notes.length === 0" class="flex flex-col items-center justify-center mt-20 text-gray-300 gap-2">
                            <i class="ph ph-ghost text-2xl"></i>
                            <span class="text-xs">没有找到笔记</span>
                        </div>
                    </template>
                </div>
            </div>

            <main class="flex-1 flex flex-col bg-white min-w-0 relative h-full">
                <header v-if="hasActiveNote && currentView !== 'trash'" class="h-12 flex items-center justify-between px-6 shrink-0 z-20 bg-white sticky top-0">
                    <div class="flex items-center gap-2 text-xs text-gray-400">
                        <button v-if="window.innerWidth < 768" @click="currentNote=null" class="mr-2 text-gray-600"><i class="ph ph-caret-left text-lg"></i></button>
                        
                        <button @click="sidebarOpen = !sidebarOpen" class="hover:text-gray-800 transition hidden md:block" title="切换侧边栏"><i class="ph ph-sidebar-simple text-lg"></i></button>
                        
                        <span class="mx-1 text-gray-300">/</span>
                        <span>{{ currentNote && currentNote.folderId ? getFolderName(currentNote.folderId) : '根目录' }}</span>
                        
                        <span class="ml-3 flex items-center gap-1 transition-all" :class="saveStatus === '同步中...' ? 'text-blue-500' : 'text-gray-300'">
                            <i v-if="saveStatus === '同步中...'" class="ph ph-arrows-clockwise spin"></i>
                            <i v-else-if="saveStatus === '已同步'" class="ph ph-cloud-check"></i>
                            <i v-else class="ph ph-warning-circle text-red-400"></i>
                            <span class="hidden sm:inline text-[10px]">{{ saveStatus }}</span>
                        </span>
                    </div>

                    <div class="flex items-center gap-1.5">
                         <div class="bg-gray-100 p-0.5 rounded-lg flex text-xs font-medium text-gray-500 mr-2">
                             <button @click="isPreviewMode=false" :class="!isPreviewMode?'bg-white text-black shadow-sm':''" class="px-3 py-1 rounded-md transition-all">编辑</button>
                             <button @click="isPreviewMode=true" :class="isPreviewMode?'bg-white text-black shadow-sm':''" class="px-3 py-1 rounded-md transition-all">预览</button>
                         </div>

                         <button @click="openShare(currentNote)" :class="currentNote.share_id ? 'text-blue-600 bg-blue-50' : 'text-gray-400 hover:text-gray-600 hover:bg-gray-100'" class="p-1.5 rounded-md transition" title="分享"><i class="ph ph-share-network text-lg"></i></button>
                         <button @click="deleteNote(currentNote)" class="text-gray-400 hover:text-red-600 hover:bg-red-50 p-1.5 rounded-md transition" title="删除"><i class="ph ph-trash text-lg"></i></button>
                    </div>
                </header>

                <div v-if="hasActiveNote && currentView !== 'trash'" class="flex-1 overflow-y-auto custom-scroll relative bg-white" id="editorContainer">
                    <div class="max-w-3xl mx-auto px-8 py-12 min-h-full flex flex-col">
                        
                        <input v-model="currentNote.title" @input="debouncedSave" placeholder="无标题" class="text-4xl font-bold text-gray-900 placeholder-gray-300 outline-none mb-6 bg-transparent w-full leading-tight font-serif">
                        
                        <div v-if="!isPreviewMode" class="flex items-center gap-1 py-2 mb-6 border-b border-gray-100 text-gray-400 sticky top-0 bg-white z-10">
                            <button @click="insertFormat('**', '**')" class="p-1.5 hover:bg-gray-100 rounded hover:text-black" title="加粗"><i class="ph ph-text-b"></i></button>
                            <button @click="insertFormat('*', '*')" class="p-1.5 hover:bg-gray-100 rounded hover:text-black" title="斜体"><i class="ph ph-text-italic"></i></button>
                            <button @click="insertFormat('## ', '')" class="p-1.5 hover:bg-gray-100 rounded hover:text-black" title="标题"><i class="ph ph-text-h-two"></i></button>
                            <button @click="insertFormat('- ', '')" class="p-1.5 hover:bg-gray-100 rounded hover:text-black" title="列表"><i class="ph ph-list-dashes"></i></button>
                            <button @click="insertFormat('`', '`')" class="p-1.5 hover:bg-gray-100 rounded hover:text-black" title="代码"><i class="ph ph-code"></i></button>
                            <div class="flex-1"></div>
                            <span class="text-[10px] text-gray-300 select-none">Markdown 支持</span>
                        </div>

                        <div class="flex-1 relative">
                            <textarea 
                                v-show="!isPreviewMode"
                                ref="textareaRef"
                                id="mainEditor" 
                                v-model="currentNote.content" 
                                @input="handleInput" 
                                @keydown.ctrl.s.prevent="saveNote"
                                @keydown.meta.s.prevent="saveNote"
                                @keydown.tab.prevent="handleTab" 
                                placeholder="输入内容，支持 Markdown..." 
                                class="editor-textarea"
                            ></textarea>

                            <div v-if="isPreviewMode" class="prose prose-slate prose-lg max-w-none font-serif text-gray-800" v-html="renderedContent"></div>
                        </div>
                    </div>
                </div>

                <div v-else class="flex-1 flex flex-col items-center justify-center bg-[#FCFBF9] text-gray-300 select-none">
                    <div v-if="currentView === 'trash'" class="text-center">
                        <i class="ph ph-trash text-4xl mb-3"></i>
                        <p class="text-sm">笔记在回收站中，无法编辑</p>
                    </div>
                    <div v-else class="text-center">
                        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                            <i class="ph ph-pencil-simple-slash text-4xl text-gray-300"></i>
                        </div>
                        <p class="text-sm font-medium text-gray-400">选择笔记或新建开始记录</p>
                    </div>
                </div>
            </main>
        </template>

        <div v-if="folderModal.show" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/20 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-xl w-80 shadow-2xl transform transition-all scale-100 border border-gray-100">
                <div class="text-center mb-4">
                    <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i :class="folderModal.mode==='create'?'ph-folder-plus':'ph-lock-key'" class="ph text-xl text-gray-700"></i>
                    </div>
                    <h3 class="font-bold text-gray-800">{{ folderModal.mode === 'create' ? '新建文件夹' : '验证密码' }}</h3>
                </div>
                
                <input v-if="folderModal.mode === 'create'" v-model="folderModal.name" placeholder="文件夹名称" class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg mb-3 text-sm outline-none focus:border-gray-800 transition">
                
                <input type="password" v-model="folderModal.pwd" @keyup.enter="handleFolderSubmit" :placeholder="folderModal.mode === 'create' ? '可选：设置访问密码' : '请输入文件夹密码'" class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg mb-4 text-sm outline-none focus:border-gray-800 transition">
                
                <div class="flex gap-2">
                    <button @click="folderModal.show=false" class="flex-1 py-2 text-gray-500 bg-white border border-gray-200 rounded-lg text-sm font-medium hover:bg-gray-50 transition">取消</button>
                    <button @click="handleFolderSubmit" class="flex-1 py-2 bg-gray-900 text-white rounded-lg text-sm font-bold hover:bg-black transition shadow-lg shadow-gray-200">确定</button>
                </div>
            </div>
        </div>

        <div v-if="shareModal.show" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/20 backdrop-blur-sm">
            <div class="bg-white p-5 rounded-xl w-96 shadow-xl border border-gray-100">
                <div class="flex justify-between mb-4 items-center">
                    <h3 class="font-bold text-gray-800 flex gap-2 items-center text-sm"><i class="ph ph-share-network"></i> 分享笔记</h3>
                    <button @click="shareModal.show=false" class="text-gray-400 hover:text-gray-800"><i class="ph ph-x"></i></button>
                </div>
                <div class="space-y-4 text-sm">
                    <div class="flex justify-between items-center bg-gray-50 p-2.5 rounded-lg border border-gray-100">
                        <label class="text-gray-600 font-medium">有效期 (天)</label>
                        <input v-model="shareModal.days" type="number" class="border border-gray-200 p-1 w-16 text-center rounded bg-white focus:outline-none focus:border-blue-500">
                    </div>
                    <button @click="doShare" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700 transition shadow-md shadow-blue-100">生成分享链接</button>
                    <div v-if="shareModal.result" class="bg-green-50 p-3 rounded-lg border border-green-100 mt-2 relative group">
                        <p class="text-[10px] text-green-600 font-bold mb-1">LINK GENERATED</p>
                        <p class="text-xs break-all font-mono text-green-800 select-all">{{ shareModal.result }}</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
        createApp({
            setup() {
                // UI & State
                const appLoading = ref(true);
                const authLoading = ref(false);
                const listLoading = ref(false);
                const sidebarOpen = ref(window.innerWidth > 768);
                const currentView = ref('all');
                const currentFolderId = ref(null);
                const folderLocked = ref(false); 
                const searchQuery = ref('');
                const searchInputRef = ref(null);
                const saveStatus = ref('已同步');
                const isPreviewMode = ref(false); // 预览模式开关
                const textareaRef = ref(null);
                
                const user = ref(null);
                const notes = ref([]);
                const folders = ref([]);
                const currentNote = ref(null);
                
                // Unlocked Folder IDs (Session Storage Logic)
                const unlockedFolderIds = ref(new Map()); 

                const mode = ref('login');
                const authForm = ref({ username: '', password: '', inviteCode: '' });
                const folderModal = ref({ show: false, mode: 'create', name: '', pwd: '', targetId: null });
                const shareModal = ref({ show: false, noteId: null, days: 7, result: '' });

                const rootFolders = computed(() => folders.value.filter(f => !f.parent_id));
                const getSubFolders = (pid) => folders.value.filter(f => f.parent_id === pid);
                const hasActiveNote = computed(() => currentNote.value && (currentNote.value.id || currentNote.value.isNew));
                
                const renderedContent = computed(() => {
                    return currentNote.value && currentNote.value.content ? marked.parse(currentNote.value.content) : '';
                });

                onMounted(async () => {
                    const saved = localStorage.getItem('baynotes_user');
                    if(saved) { try { user.value = JSON.parse(saved); await loadData(); } catch(e) { logout(); } }
                    appLoading.value = false;
                    window.addEventListener('resize', () => { if(window.innerWidth >= 768) sidebarOpen.value = true; });
                });

                const api = async (url, opts={}) => {
                    const token = localStorage.getItem('baynotes_token');
                    if(!token) { logout(); return { ok: false }; }
                    opts.headers = { ...opts.headers, 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
                    try {
                        const res = await fetch(url, opts);
                        if(res.status === 401) { logout(); return { ok: false }; }
                        return res;
                    } catch (e) { return { ok: false }; }
                };

                const loadData = async () => {
                    try { const r = await api('/api/folders'); if(r.ok) folders.value = await r.json(); } catch(e){}
                    await fetchNotes();
                };

                const fetchNotes = async () => {
                    listLoading.value = true;
                    folderLocked.value = false;
                    notes.value = [];

                    if(currentView.value === 'folder' && currentFolderId.value) {
                        const f = folders.value.find(x => x.id === currentFolderId.value);
                        if(f && f.is_encrypted && !unlockedFolderIds.value.has(f.id)) {
                            folderLocked.value = true;
                            listLoading.value = false;
                            return; 
                        }
                    }

                    let url = `/api/notes?type=${currentView.value}`;
                    if(currentView.value === 'folder') url += `&folderId=${currentFolderId.value}`;
                    if(currentView.value === 'search') url += `&q=${encodeURIComponent(searchQuery.value)}`;
                    
                    let headers = {};
                    if(currentView.value === 'folder' && unlockedFolderIds.value.has(currentFolderId.value)) {
                         const pwd = unlockedFolderIds.value.get(currentFolderId.value);
                         if(pwd) headers['X-Folder-Pwd'] = pwd;
                    }

                    const res = await api(url, { headers });
                    if(res.ok) {
                        notes.value = await res.json();
                    } else if(res.status === 403) {
                         folderLocked.value = true;
                    }
                    listLoading.value = false;
                };

                const isFolderUnlocked = (id) => unlockedFolderIds.value.has(id);
                
                const handleFolderClick = (f) => {
                    setView('folder', f.id);
                };

                const setView = (v, id=null) => { 
                    currentView.value=v; currentFolderId.value=id; currentNote.value=null;
                    if(v!=='search') searchQuery.value=''; 
                    fetchNotes(); 
                    if(window.innerWidth < 768) sidebarOpen.value = false;
                };

                const doSearch = () => { searchQuery.value=''; currentView.value='search'; currentNote.value=null; notes.value=[]; nextTick(()=>searchInputRef.value?.focus()); };

                const handleAuth = async () => {
                    if(!authForm.value.username || !authForm.value.password) return alert("输入账号密码");
                    authLoading.value = true;
                    try {
                        const res = await fetch('/api/auth', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:mode.value, ...authForm.value})});
                        const data = await res.json();
                        if(!res.ok) throw new Error(data.error);
                        if(mode.value==='register') { alert("注册成功"); mode.value='login'; }
                        else { 
                            localStorage.setItem('baynotes_token', data.token); localStorage.setItem('baynotes_user', JSON.stringify(data.user)); 
                            user.value = data.user; await nextTick(); loadData();
                        }
                    } catch(e) { alert(e.message); } finally { authLoading.value = false; }
                };
                const logout = () => { localStorage.clear(); user.value=null; notes.value=[]; unlockedFolderIds.value = new Map(); };

                const initNewNote = () => {
                    if(currentView.value === 'folder' && folderLocked.value) return promptUnlock();
                    currentNote.value = { isNew: true, title: '', content: '', folderId: currentView.value==='folder' ? currentFolderId.value : null };
                    isPreviewMode.value = false;
                    if(window.innerWidth < 768) sidebarOpen.value = false;
                    nextTick(() => autoResizeTextarea());
                };
                const selectNote = (n) => { currentNote.value={...n}; isPreviewMode.value = false; nextTick(() => autoResizeTextarea()); };
                
                const deleteNote = async (n) => { 
                    if(confirm("移入回收站?")) { 
                        await api(`/api/notes?id=${n.id}`, {method:'DELETE'}); 
                        notes.value = notes.value.filter(x=>x.id!==n.id); 
                        currentNote.value=null; 
                    }
                };

                const createFolder = (pid) => { folderModal.value = { show:true, mode:'create', name:'', pwd:'', parentId: pid }; };
                const deleteFolder = async (id) => { if(confirm("删除文件夹? 笔记将移至根目录。")) { await api(`/api/folders?id=${id}`, {method:'DELETE'}); loadData(); if(currentFolderId.value===id) setView('all'); }};
                
                const lockFolder = (id) => {
                    unlockedFolderIds.value.delete(id); 
                    if(currentFolderId.value === id) fetchNotes(); 
                };

                const promptUnlock = () => {
                    if(!currentFolderId.value) return;
                    folderModal.value = { show: true, mode: 'unlock', pwd: '', targetId: currentFolderId.value };
                };

                const handleFolderSubmit = async () => {
                    const m = folderModal.value;
                    if(m.mode === 'create') {
                        if(!m.name) return alert("请输入名称");
                        await api('/api/folders', {method:'POST', body:JSON.stringify({name: m.name, parentId: m.parentId, password: m.pwd})});
                        loadData();
                    } else {
                        if(!m.pwd) return;
                        const res = await api('/api/folders', {method:'POST', body:JSON.stringify({action:'verify', folderId: m.targetId, password: m.pwd})});
                        if(res.ok) {
                            unlockedFolderIds.value.set(m.targetId, m.pwd); 
                            if(currentFolderId.value === m.targetId) fetchNotes(); 
                        } else {
                            alert("密码错误");
                            return;
                        }
                    }
                    folderModal.value.show = false;
                };

                let timer;
                const debouncedSave = () => { saveStatus.value='同步中...'; clearTimeout(timer); timer=setTimeout(saveNote, 800); };
                
                const handleInput = (e) => {
                    autoResizeTextarea();
                    debouncedSave();
                };

                const autoResizeTextarea = () => {
                    const el = textareaRef.value;
                    if(!el) return;
                    el.style.height = 'auto';
                    el.style.height = el.scrollHeight + 'px';
                };

                const saveNote = async () => {
                    if(!currentNote.value || (!currentNote.value.title && !currentNote.value.content && currentNote.value.isNew)) return;
                    const res = await api('/api/notes', {method:'POST', body:JSON.stringify(currentNote.value)});
                    if(res.ok) {
                        const d = await res.json();
                        if(currentNote.value.isNew) { currentNote.value.id=d.id; delete currentNote.value.isNew; notes.value.unshift(currentNote.value); }
                        saveStatus.value='已同步';
                    } else { saveStatus.value='失败'; }
                };

                const insertFormat = (b, a) => {
                    const t = document.getElementById('mainEditor'); if(!t) return;
                    const s = t.selectionStart, e = t.selectionEnd, v = currentNote.value.content||'';
                    currentNote.value.content = v.substring(0, s) + b + v.substring(s, e) + a + v.substring(e);
                    nextTick(() => { t.focus(); t.selectionStart = s + b.length; t.selectionEnd = e + b.length; autoResizeTextarea(); });
                    debouncedSave();
                };
                const handleTab = (e) => { insertFormat('  ', ''); };

                const openShare = (n) => { shareModal.value={show:true, noteId:n.id, days:7, result:''}; };
                const doShare = async () => {
                    const res = await api('/api/notes', {method:'PATCH', body:JSON.stringify({...shareModal.value, noteId:currentNote.value.id})});
                    const d = await res.json();
                    shareModal.value.result = `${window.location.origin}/view.html?id=${d.shareId}`;
                    currentNote.value.share_id = d.shareId;
                };

                const getViewTitle = () => {
                    const map = {all:'全部笔记', trash:'回收站', shared:'分享中', search:'搜索结果'};
                    if(currentView.value in map) return map[currentView.value];
                    const f = folders.value.find(x=>x.id===currentFolderId.value);
                    return f ? f.name : '文件夹';
                };
                const getFolderName = (id) => folders.value.find(x=>x.id===id)?.name || '...';
                
                const relativeTime = (ts) => {
                    const now = Date.now() / 1000;
                    const diff = now - ts;
                    if(diff < 60) return '刚刚';
                    if(diff < 3600) return Math.floor(diff/60) + '分钟前';
                    if(diff < 86400) return Math.floor(diff/3600) + '小时前';
                    return new Date(ts*1000).toLocaleDateString();
                };

                return {
                    appLoading, authLoading, listLoading, sidebarOpen, user, notes, rootFolders, getSubFolders, currentNote, hasActiveNote, currentView, searchQuery, searchInputRef, saveStatus, folderLocked, isPreviewMode, renderedContent, textareaRef,
                    mode, authForm, folderModal, shareModal, 
                    handleAuth, logout, initNewNote, selectNote, createFolder, deleteFolder, deleteNote, lockFolder, handleFolderSubmit, isFolderUnlocked, promptUnlock,
                    debouncedSave, handleInput, saveNote, insertFormat, handleTab, openShare, doShare, setView, doSearch, handleFolderClick, getViewTitle, getFolderName, relativeTime, currentFolderId
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
