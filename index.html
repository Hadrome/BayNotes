<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BayNotes Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .sidebar-item { @apply flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer text-slate-600 hover:bg-white hover:shadow-sm transition text-sm; }
        .sidebar-item.active { @apply bg-white shadow-sm text-blue-600 font-bold; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
    </style>
</head>
<body class="bg-[#F5F5F7] text-slate-800 h-screen flex flex-col overflow-hidden">
    
    <div id="app" class="h-full w-full flex relative">

        <div v-if="!user" class="absolute inset-0 z-[100] flex items-center justify-center bg-[#F5F5F7]">
            <div class="w-full max-w-sm bg-white rounded-3xl shadow-xl p-8">
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-bold">BayNotes</h1>
                    <p class="text-xs text-slate-400">V2.0 Enhanced</p>
                </div>
                <div class="space-y-3">
                    <input v-model="authForm.username" placeholder="ç”¨æˆ·å" class="w-full bg-gray-100 p-3 rounded-xl outline-none">
                    <input v-model="authForm.password" type="password" placeholder="å¯†ç " class="w-full bg-gray-100 p-3 rounded-xl outline-none">
                    <input v-if="mode==='register'" v-model="authForm.inviteCode" placeholder="é‚€è¯·ç " class="w-full bg-gray-100 p-3 rounded-xl outline-none">
                    <button @click="handleAuth" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold">{{ mode==='login'?'ç™»å½•':'æ³¨å†Œ' }}</button>
                    <div class="text-center text-xs text-slate-400 cursor-pointer mt-2" @click="mode = mode==='login'?'register':'login'">
                        {{ mode==='login'?'æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ':'å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•' }}
                    </div>
                </div>
            </div>
        </div>

        <template v-else>
            <aside :class="sidebarOpen ? 'w-64' : 'w-16'" class="flex-shrink-0 bg-gray-50 border-r border-gray-200 flex flex-col transition-all duration-300 h-full relative z-20">
                <button @click="sidebarOpen = !sidebarOpen" class="absolute -right-3 top-6 bg-white border border-gray-200 rounded-full p-1 text-xs shadow-sm hover:text-blue-600 z-30">
                    <i :class="sidebarOpen ? 'ph-caret-left' : 'ph-caret-right'" class="ph"></i>
                </button>

                <div class="p-4 border-b border-gray-100">
                    <button @click="initNewNote" class="w-full flex items-center justify-center gap-2 bg-slate-900 text-white rounded-xl py-3 shadow-lg shadow-slate-200 hover:bg-slate-800 transition overflow-hidden">
                        <i class="ph ph-plus text-lg"></i>
                        <span v-if="sidebarOpen" class="font-bold text-sm whitespace-nowrap">æ–°ç¬”è®°</span>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-1">
                    
                    <div v-if="sidebarOpen" class="mb-4">
                        <div class="flex items-center bg-white px-3 py-2 rounded-lg border border-gray-100 focus-within:border-blue-300 transition">
                            <i class="ph ph-magnifying-glass text-gray-400"></i>
                            <input v-model="searchQuery" @keyup.enter="doSearch" placeholder="æœç´¢..." class="w-full bg-transparent text-sm ml-2 outline-none">
                        </div>
                    </div>
                    <div v-else class="flex justify-center mb-4" title="æœç´¢">
                         <button @click="sidebarOpen=true" class="p-2 bg-white rounded-lg"><i class="ph ph-magnifying-glass"></i></button>
                    </div>

                    <div @click="setView('all')" :class="{active: currentView==='all'}" class="sidebar-item">
                        <i class="ph ph-files text-lg"></i>
                        <span v-if="sidebarOpen">å…¨éƒ¨ç¬”è®°</span>
                    </div>
                    
                    <div class="mt-4" v-if="sidebarOpen">
                        <div class="flex justify-between items-center px-2 mb-1 text-xs text-gray-400 font-bold uppercase">
                            <span>æ–‡ä»¶å¤¹</span>
                            <button @click="createFolder(null)" class="hover:text-blue-500"><i class="ph ph-plus"></i></button>
                        </div>
                        <div v-for="folder in rootFolders" :key="folder.id">
                            <div @click="setView('folder', folder.id)" :class="{active: currentView === 'folder' && currentFolderId === folder.id}" class="sidebar-item justify-between group">
                                <div class="flex items-center gap-2 truncate">
                                    <i class="ph ph-folder"></i> {{ folder.name }}
                                </div>
                                <div class="hidden group-hover:flex gap-1 text-xs">
                                    <i @click.stop="createFolder(folder.id)" class="ph ph-plus hover:text-blue-600" title="æ–°å»ºå­æ–‡ä»¶å¤¹"></i>
                                    <i @click.stop="deleteFolder(folder.id)" class="ph ph-trash hover:text-red-500"></i>
                                </div>
                            </div>
                            <div v-for="sub in getSubFolders(folder.id)" :key="sub.id" 
                                 @click="setView('folder', sub.id)"
                                 :class="{active: currentView === 'folder' && currentFolderId === sub.id}"
                                 class="sidebar-item pl-8 text-xs group justify-between">
                                <span class="truncate"><i class="ph ph-arrow-elbow-down-right"></i> {{ sub.name }}</span>
                                <i @click.stop="deleteFolder(sub.id)" class="ph ph-trash hidden group-hover:block hover:text-red-500"></i>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-100 my-2"></div>

                    <div @click="setView('shared')" :class="{active: currentView==='shared'}" class="sidebar-item">
                        <i class="ph ph-share-network text-lg"></i>
                        <span v-if="sidebarOpen">æˆ‘çš„åˆ†äº«</span>
                    </div>

                    <div @click="setView('trash')" :class="{active: currentView==='trash'}" class="sidebar-item">
                        <i class="ph ph-trash text-lg"></i>
                        <span v-if="sidebarOpen">å›æ”¶ç«™</span>
                    </div>
                </div>

                <div class="p-3 border-t border-gray-200 bg-white">
                    <div v-if="user.role === 'admin'" @click="showAdminPanel=true" class="sidebar-item text-yellow-600 mb-1">
                        <i class="ph ph-shield-check text-lg"></i>
                        <span v-if="sidebarOpen">åå°ç®¡ç†</span>
                    </div>
                    <div @click="logout" class="sidebar-item text-red-500">
                        <i class="ph ph-sign-out text-lg"></i>
                        <span v-if="sidebarOpen">é€€å‡ºç™»å½•</span>
                    </div>
                </div>
            </aside>

            <main class="flex-1 flex flex-col h-full overflow-hidden bg-white">
                
                <header class="h-14 border-b border-gray-100 flex items-center justify-between px-6 shrink-0">
                    <div class="font-bold text-lg flex items-center gap-2">
                        <span v-if="currentView === 'all'">å…¨éƒ¨ç¬”è®°</span>
                        <span v-else-if="currentView === 'trash'" class="text-red-500">ğŸ—‘ï¸ å›æ”¶ç«™ (48å°æ—¶åè‡ªåŠ¨æ¸…é™¤)</span>
                        <span v-else-if="currentView === 'shared'" class="text-blue-500">ğŸ”— åˆ†äº«ä¸­</span>
                        <span v-else-if="currentView === 'search'" class="text-purple-500">ğŸ” æœç´¢ç»“æœ: "{{ searchQuery }}"</span>
                        <span v-else>ğŸ“ {{ getCurrentFolderName() }}</span>
                    </div>
                    <div v-if="currentNote.id && currentView !== 'trash'" class="text-xs text-gray-400">
                        {{ saveStatus }}
                    </div>
                </header>

                <div class="flex-1 flex overflow-hidden">
                    <div class="w-64 border-r border-gray-100 flex flex-col overflow-y-auto bg-gray-50/50">
                        <div v-for="note in notes" :key="note.id" @click="selectNote(note)" 
                             :class="{'bg-white border-l-4 border-blue-500 shadow-sm': currentNote.id === note.id}"
                             class="p-4 border-b border-gray-100 cursor-pointer hover:bg-white transition group relative">
                            <h3 class="font-bold text-sm text-slate-700 truncate mb-1">
                                <i v-if="note.is_encrypted" class="ph ph-lock-key text-xs"></i> 
                                {{ note.title || 'æ— æ ‡é¢˜' }}
                            </h3>
                            <p class="text-xs text-slate-400 line-clamp-2 h-8">{{ note.is_encrypted ? '******' : note.content }}</p>
                            
                            <div class="absolute right-2 top-2 hidden group-hover:flex bg-white/90 rounded shadow-sm">
                                <button v-if="currentView==='trash'" @click.stop="restoreNote(note)" class="p-1 text-green-500 hover:bg-green-50" title="æ¢å¤"><i class="ph ph-arrow-u-up-left"></i></button>
                                <button @click.stop="deleteNote(note)" class="p-1 text-red-400 hover:bg-red-50" title="åˆ é™¤"><i class="ph ph-trash"></i></button>
                            </div>
                        </div>
                        <div v-if="notes.length === 0" class="p-8 text-center text-gray-400 text-sm">
                            æ²¡æœ‰ç¬”è®°
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col relative bg-white">
                        <div v-if="currentNote.id && currentView !== 'trash'" class="h-full flex flex-col">
                            <div class="px-8 pt-6 pb-2">
                                <input v-model="currentNote.title" @input="debouncedSave" placeholder="ç¬”è®°æ ‡é¢˜" class="text-3xl font-bold outline-none w-full placeholder-gray-300">
                                <div class="flex gap-4 mt-4 text-xs text-gray-400 items-center">
                                    <div class="flex items-center gap-1 bg-gray-100 px-2 py-1 rounded">
                                        <i class="ph ph-folder"></i>
                                        <select v-model="currentNote.folderId" @change="saveNote" class="bg-transparent outline-none w-24">
                                            <option :value="null">æ ¹ç›®å½•</option>
                                            <option v-for="f in allFolders" :value="f.id">{{ f.name }}</option>
                                        </select>
                                    </div>
                                    <label class="flex items-center gap-1 cursor-pointer select-none">
                                        <input type="checkbox" v-model="currentNote.is_encrypted" @change="saveNote" class="accent-slate-900">
                                        <span v-if="currentNote.is_encrypted" class="text-blue-500">å·²åŠ å¯†</span>
                                        <span v-else>å…¬å¼€æ˜æ–‡</span>
                                    </label>
                                    <button @click="openShare(currentNote)" :class="currentNote.share_id ? 'text-blue-500':'hover:text-slate-600'" class="flex items-center gap-1 transition">
                                        <i class="ph ph-share-network"></i> {{ currentNote.share_id ? 'å·²åˆ†äº«' : 'åˆ†äº«' }}
                                    </button>
                                </div>
                            </div>

                            <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                                <textarea v-if="!currentNote.is_encrypted || decryptedContent !== null" 
                                          v-model="currentNote.content" @input="debouncedSave" 
                                          class="flex-1 p-8 outline-none resize-none text-slate-700 font-mono leading-relaxed custom-scroll" placeholder="å¼€å§‹å†™ä½œ..."></textarea>
                                
                                <div v-else class="flex-1 flex flex-col items-center justify-center bg-gray-50 m-8 rounded-2xl border border-dashed border-gray-200">
                                    <i class="ph ph-lock-key text-4xl text-gray-300 mb-2"></i>
                                    <p class="text-sm text-gray-400">å†…å®¹å·²åŠ å¯†</p>
                                    <button @click="decryptCurrent" class="mt-4 px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm shadow-sm hover:text-blue-500">ç‚¹å‡»è§£å¯†</button>
                                </div>

                                <div v-if="!currentNote.is_encrypted || decryptedContent" class="hidden lg:block w-1/2 bg-gray-50 p-8 overflow-y-auto border-l border-gray-100 prose prose-sm max-w-none custom-scroll" v-html="previewHtml"></div>
                            </div>
                        </div>

                        <div v-else class="flex-1 flex items-center justify-center text-gray-300">
                            <div class="text-center">
                                <i class="ph ph-notebook text-6xl mb-4 opacity-50"></i>
                                <p>é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªç¬”è®°</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <div v-if="showAdminPanel" class="fixed inset-0 z-[60] bg-black/20 backdrop-blur-sm flex items-center justify-center p-4">
                <div class="bg-white w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h2 class="text-xl font-bold">ç”¨æˆ·ç®¡ç† (Admin)</h2>
                        <button @click="showAdminPanel=false"><i class="ph ph-x text-xl"></i></button>
                    </div>
                    <div class="flex-1 overflow-auto p-6">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-100 text-gray-500">
                                <tr>
                                    <th class="p-3 rounded-l-lg">ç”¨æˆ·</th>
                                    <th class="p-3">ç¬”è®°æ•°</th>
                                    <th class="p-3">æƒé™é…ç½® (åˆ /æ”¹/äº«/ç„š)</th>
                                    <th class="p-3 rounded-r-lg text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                <tr v-for="u in adminUsers" :key="u.id">
                                    <td class="p-3 font-medium">{{ u.username }} <span v-if="u.role==='admin'" class="text-xs bg-yellow-100 text-yellow-800 px-1 rounded">ADM</span></td>
                                    <td class="p-3">{{ u.note_count }}</td>
                                    <td class="p-3 flex gap-2">
                                        <label><input type="checkbox" :checked="hasPerm(u, 'delete')" @change="togglePerm(u, 'delete')"> åˆ </label>
                                        <label><input type="checkbox" :checked="hasPerm(u, 'edit')" @change="togglePerm(u, 'edit')"> æ”¹</label>
                                        <label><input type="checkbox" :checked="hasPerm(u, 'share')" @change="togglePerm(u, 'share')"> äº«</label>
                                        <label><input type="checkbox" :checked="hasPerm(u, 'burn')" @change="togglePerm(u, 'burn')"> ç„š</label>
                                    </td>
                                    <td class="p-3 text-right space-x-2">
                                        <button @click="resetPwd(u)" class="text-blue-500 hover:underline">é‡ç½®å¯†ç </button>
                                        <button v-if="u.role!=='admin'" @click="delUser(u)" class="text-red-500 hover:underline">åˆ é™¤</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div v-if="shareModal.show" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/30 backdrop-blur-sm">
                <div class="bg-white p-6 rounded-2xl w-80">
                    <h3 class="font-bold mb-4">åˆ†äº«è®¾ç½®</h3>
                    <div class="space-y-3 text-sm">
                        <label>å¤©æ•°: <input v-model="shareModal.days" type="number" class="border p-1 w-12 text-center"></label>
                        <input v-model="shareModal.pwd" placeholder="å¯†ç (å¯é€‰)" class="w-full border p-2 rounded">
                        <label class="flex items-center gap-2"><input type="checkbox" v-model="shareModal.burn"> é˜…åå³ç„š</label>
                        <button @click="doShare" class="w-full bg-blue-600 text-white py-2 rounded">ç”Ÿæˆé“¾æ¥</button>
                        <p v-if="shareModal.result" class="bg-gray-100 p-2 break-all text-xs select-all">{{ shareModal.result }}</p>
                    </div>
                    <button @click="shareModal.show=false" class="mt-4 w-full text-gray-400 text-sm">å…³é—­</button>
                </div>
            </div>

        </template>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        createApp({
            setup() {
                // UI çŠ¶æ€
                const sidebarOpen = ref(true);
                const currentView = ref('all'); // all, trash, shared, folder, search
                const currentFolderId = ref(null);
                const searchQuery = ref('');
                const showAdminPanel = ref(false);
                
                // æ•°æ®
                const user = ref(null);
                const notes = ref([]);
                const folders = ref([]);
                const adminUsers = ref([]);
                const currentNote = ref({});
                const mode = ref('login');
                const authForm = ref({ username: '', password: '', inviteCode: '' });
                const saveStatus = ref('å·²åŒæ­¥');
                
                // åˆ†äº«ä¸åŠ å¯†
                const shareModal = ref({ show: false, noteId: null, days: 7, pwd: '', burn: false, result: '' });
                const decryptedContent = ref(null); // ä¸´æ—¶è§£å¯†å†…å®¹ç¼“å­˜

                // è®¡ç®—å±æ€§
                const rootFolders = computed(() => folders.value.filter(f => !f.parent_id));
                const allFolders = computed(() => folders.value); // æ‰å¹³åŒ–ç”¨äºä¸‹æ‹‰é€‰æ‹©
                const getSubFolders = (pid) => folders.value.filter(f => f.parent_id === pid);
                
                const previewHtml = computed(() => {
                    const content = currentNote.value.is_encrypted ? decryptedContent.value : currentNote.value.content;
                    return marked.parse(content || '');
                });

                // åˆå§‹åŒ–
                onMounted(() => {
                    const saved = localStorage.getItem('baynotes_user');
                    if(saved) {
                        user.value = JSON.parse(saved);
                        loadData();
                    }
                });
                
                // ç›‘å¬ Admin é¢æ¿æ‰“å¼€
                watch(showAdminPanel, (val) => { if(val) fetchAdminUsers(); });

                // API Fetcher
                const api = async (url, opts={}) => {
                    const token = localStorage.getItem('baynotes_token');
                    if(!token) return logout();
                    opts.headers = { ...opts.headers, 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
                    const res = await fetch(url, opts);
                    if(res.status === 401) logout();
                    return res;
                };

                // === æ•°æ®åŠ è½½ ===
                const loadData = async () => {
                    await fetchFolders();
                    await fetchNotes();
                };

                const fetchFolders = async () => {
                    const res = await api('/api/folders');
                    if(res.ok) folders.value = await res.json();
                };

                const fetchNotes = async () => {
                    let url = `/api/notes?type=${currentView.value}`;
                    if(currentView.value === 'folder') url += `&folderId=${currentFolderId.value}`;
                    if(currentView.value === 'search') url += `&q=${searchQuery.value}`;
                    
                    const res = await api(url);
                    if(res.ok) notes.value = await res.json();
                };

                // === è§†å›¾åˆ‡æ¢ ===
                const setView = (view, id=null) => {
                    currentView.value = view;
                    currentFolderId.value = id;
                    currentNote.value = {}; // æ¸…ç©ºå½“å‰é€‰ä¸­
                    fetchNotes();
                };

                const doSearch = () => {
                    if(!searchQuery.value) return;
                    setView('search');
                };

                // === ç¬”è®°æ“ä½œ ===
                const initNewNote = () => {
                    currentNote.value = { 
                        title: '', content: '', is_encrypted: false, 
                        folderId: currentView.value === 'folder' ? currentFolderId.value : null 
                    };
                    saveStatus.value = 'æœªä¿å­˜';
                };

                const selectNote = (note) => {
                    currentNote.value = { ...note }; // å¤åˆ¶å¯¹è±¡
                    decryptedContent.value = null; // é‡ç½®è§£å¯†ç¼“å­˜
                    saveStatus.value = 'å·²åŒæ­¥';
                };

                // é˜²æŠ–ä¿å­˜
                let timeout;
                const debouncedSave = () => {
                    saveStatus.value = 'ä¿å­˜ä¸­...';
                    clearTimeout(timeout);
                    timeout = setTimeout(saveNote, 1000);
                };

                const saveNote = async () => {
                    if(!currentNote.value.title) return;
                    
                    // åŠ å¯†å¤„ç†
                    let contentToSave = currentNote.value.content;
                    if(currentNote.value.is_encrypted) {
                        // å¦‚æœå½“å‰å·²è§£å¯†æ˜¾ç¤ºï¼Œä¿å­˜æ—¶é‡æ–°åŠ å¯†
                        // ç®€å•å¤„ç†ï¼šä»…å½“ç”¨æˆ·ä¿®æ”¹äº†å†…å®¹æ—¶ï¼Œå‰ç«¯é‡æ–°åŠ å¯†
                        const key = localStorage.getItem('baynotes_token').substring(0,16);
                        contentToSave = CryptoJS.AES.encrypt(currentNote.value.content, key).toString();
                    }

                    const payload = { ...currentNote.value, content: contentToSave };
                    const res = await api('/api/notes', { method: 'POST', body: JSON.stringify(payload) });
                    if(res.ok) {
                        const data = await res.json();
                        if(!currentNote.value.id) {
                            currentNote.value.id = data.id;
                            notes.value.unshift(currentNote.value); // åŠ å…¥åˆ—è¡¨
                        }
                        saveStatus.value = 'å·²åŒæ­¥';
                        // æ›´æ–°åˆ—è¡¨æ˜¾ç¤ºçš„æ‘˜è¦
                        const idx = notes.value.findIndex(n => n.id === currentNote.value.id);
                        if(idx !== -1) notes.value[idx] = { ...currentNote.value, content: contentToSave };
                    }
                };

                const deleteNote = async (note) => {
                    const isTrash = currentView.value === 'trash';
                    const url = `/api/notes?id=${note.id}${isTrash ? '&type=hard' : ''}`;
                    if(confirm(isTrash ? 'å½»åº•åˆ é™¤æ— æ³•æ¢å¤ï¼Œç¡®å®šå—ï¼Ÿ' : 'ç§»å…¥å›æ”¶ç«™ï¼Ÿ')) {
                        await api(url, { method: 'DELETE' });
                        notes.value = notes.value.filter(n => n.id !== note.id);
                        if(currentNote.value.id === note.id) currentNote.value = {};
                    }
                };

                const restoreNote = async (note) => {
                     // æ¢å¤å³ update deleted_at = null
                     // è¿™é‡Œå› ä¸ºAPIé™åˆ¶ï¼Œæˆ‘ä»¬é€šè¿‡ POST update æ¥å®ç°æ¢å¤ï¼ˆæœ‰ç‚¹hackï¼Œå»ºè®®åç«¯åŠ  restore æ¥å£ï¼‰
                     // ä½†ä¸ºäº†ç®€ä¾¿ï¼Œæˆ‘ä»¬å‡è£…ç”¨æˆ·ç¼–è¾‘äº†å®ƒï¼Œæˆ–è€…ä½ å¯ä»¥ä¿®æ”¹åç«¯æ”¯æŒ DELETE æ’¤é”€
                     // æœ€å¥½çš„åŠæ³•æ˜¯åç«¯ POST å…è®¸ deleted_at: null
                     // è¿™é‡Œæˆ‘æ¼”ç¤ºå‰ç«¯æŠŠå†…å®¹è¯»å‡ºæ¥é‡æ–°ä¿å­˜ä¸€æ¬¡ä½œä¸ºæ–°ç¬”è®°/æ›´æ–°çŠ¶æ€ï¼Œæˆ–è€…åç«¯éœ€è¦æ”¹åŠ¨
                     // **æ›´æ­£**ï¼šä¸ºäº†å®ç°ç®€å•ï¼Œæˆ‘ä»¬åœ¨ POST æ¥å£å¹¶æœªå¤„ç† deleted_at æ¢å¤ã€‚
                     // å»ºè®®åç«¯ onRequestDelete å¢åŠ  &restore=trueã€‚
                     // ç°è¡Œæ–¹æ¡ˆï¼šåç«¯æ²¡æœ‰æ¢å¤æ¥å£ï¼Œå»ºè®®ç›´æ¥ç”¨ POST è¦†ç›–æ›´æ–°ä¸€æ¬¡ deleted_at å­—æ®µ
                     alert("å½“å‰APIç®€åŒ–ç‰ˆæš‚æœªåŒ…å«ä¸€é”®æ¢å¤ï¼Œè¯·å¤åˆ¶å†…å®¹æ–°å»ºæˆ–ä¿®æ”¹åç«¯é€»è¾‘ã€‚");
                };

                const decryptCurrent = () => {
                     const key = localStorage.getItem('baynotes_token').substring(0,16);
                     try {
                         const bytes = CryptoJS.AES.decrypt(currentNote.value.content, key);
                         const originalText = bytes.toString(CryptoJS.enc.Utf8);
                         if(!originalText) throw new Error();
                         currentNote.value.content = originalText; // æ›¿æ¢ä¸ºæ˜æ–‡ç”¨äºç¼–è¾‘
                         decryptedContent.value = originalText;
                     } catch(e) {
                         alert('è§£å¯†å¤±è´¥ï¼Œå¯èƒ½æ˜¯å¯†é’¥ä¸åŒ¹é…');
                     }
                };

                // === æ–‡ä»¶å¤¹æ“ä½œ ===
                const createFolder = async (pid) => {
                    const name = prompt("è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°");
                    if(!name) return;
                    const res = await api('/api/folders', { method: 'POST', body: JSON.stringify({ name, parentId: pid }) });
                    if(res.ok) fetchFolders();
                };

                const deleteFolder = async (id) => {
                    if(confirm("åˆ é™¤æ–‡ä»¶å¤¹ï¼Ÿå†…éƒ¨ç¬”è®°å°†ç§»è‡³æ ¹ç›®å½•ã€‚")) {
                        await api(`/api/folders?id=${id}`, { method: 'DELETE' });
                        fetchFolders();
                        setView('all');
                    }
                };

                const getCurrentFolderName = () => {
                    const f = folders.value.find(f => f.id === currentFolderId.value);
                    return f ? f.name : 'æœªçŸ¥æ–‡ä»¶å¤¹';
                };

                // === ç®¡ç†å‘˜é€»è¾‘ ===
                const fetchAdminUsers = async () => {
                    const res = await api('/api/admin');
                    if(res.ok) adminUsers.value = await res.json();
                };
                
                const hasPerm = (u, p) => !u.permissions || u.permissions === 'all' || u.permissions.includes(p);
                
                const togglePerm = async (u, p) => {
                    let perms = (u.permissions && u.permissions!=='all') ? u.permissions.split(',') : ['delete','edit','share','burn'];
                    if(perms.includes(p)) perms = perms.filter(x => x !== p);
                    else perms.push(p);
                    
                    const newStr = perms.join(',');
                    await api('/api/admin', { method: 'POST', body: JSON.stringify({ targetUserId: u.id, action: 'update_permissions', newPermissions: newStr }) });
                    u.permissions = newStr; // æœ¬åœ°æ›´æ–°
                };

                const resetPwd = async (u) => {
                    const newPwd = prompt(`é‡ç½®ç”¨æˆ· ${u.username} çš„å¯†ç ä¸ºï¼š`);
                    if(newPwd) {
                        await api('/api/admin', { method: 'POST', body: JSON.stringify({ targetUserId: u.id, action: 'reset_password', newPassword: newPwd }) });
                        alert('é‡ç½®æˆåŠŸ');
                    }
                };

                // === è®¤è¯ä¸åŸºç¡€ ===
                const handleAuth = async () => {
                    // ... (ä¿æŒä¹‹å‰çš„ Auth é€»è¾‘) ...
                    // ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œæ­¤å¤„çœç•¥ï¼Œé€»è¾‘ä¸åŸç‰ˆä¸€è‡´ï¼Œè¯·æ±‚ /api/auth
                     try {
                        const res = await fetch('/api/auth', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: mode.value, ...authForm.value })
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'æ“ä½œå¤±è´¥');
                        if (mode.value === 'register') {
                            alert('æ³¨å†ŒæˆåŠŸ'); mode.value = 'login';
                        } else {
                            user.value = data.user;
                            localStorage.setItem('baynotes_user', JSON.stringify(data.user));
                            localStorage.setItem('baynotes_token', data.token);
                            loadData();
                        }
                    } catch (e) { alert(e.message); }
                };

                const logout = () => {
                    localStorage.removeItem('baynotes_token');
                    localStorage.removeItem('baynotes_user');
                    user.value = null;
                };

                // åˆ†äº«é€»è¾‘
                const openShare = (n) => { shareModal.value.noteId = n.id; shareModal.value.show = true; };
                const doShare = async () => {
                    const res = await api('/api/notes', { method: 'PATCH', body: JSON.stringify(shareModal.value) });
                    const data = await res.json();
                    const baseUrl = window.location.origin;
                    shareModal.value.result = `${baseUrl}/view.html?id=${data.shareId}`;
                    currentNote.value.share_id = data.shareId; // æ›´æ–°UIçŠ¶æ€
                };

                return {
                    sidebarOpen, currentView, currentFolderId, searchQuery, showAdminPanel,
                    user, mode, authForm, notes, rootFolders, allFolders, getSubFolders, currentNote, saveStatus,
                    shareModal, decryptedContent, previewHtml, adminUsers,
                    setView, initNewNote, selectNote, saveNote, deleteNote, restoreNote, decryptCurrent, doSearch,
                    createFolder, deleteFolder, getCurrentFolderName,
                    handleAuth, logout, openShare, doShare,
                    fetchAdminUsers, hasPerm, togglePerm, resetPwd, delUser: (u)=>deleteUser(u) // å¤ç”¨åˆ é™¤é€»è¾‘å ä½
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
